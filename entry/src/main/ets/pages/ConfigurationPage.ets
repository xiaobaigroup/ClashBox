import { BreakpointState } from '../common/breakpointsystem'
import {
  TAB_CONTENT_TITLE_FONT_SIZE,
  TAB_CONTENT_TITLE_FONT_WEIGHT,
  ANIMATION_DURATION_300,
  TAB_CONTENT_TITLE_HEIGHT,
  TAB_CONTENT_TITLE_SYMBOL_FONT_SIZE,
  LIST_ITEM_HEIGHT,
  LIST_SPACE,
  BORDER_RADIUS_20,
  BIND_SHEET_CONTAINER_HEIGHT,
  LIST_ITEM_PADDING,
  RouteName,
} from '../common/Constants'
import { LengthMetrics, PromptAction, SymbolGlyphModifier } from '@kit.ArkUI'
import { ConfigAdd } from '../components/Configuration/ConfigAdd'
import { hilog } from '@kit.PerformanceAnalysisKit'
import { Callback } from '@ohos.base'
import { ConfigData, ConfigDataSource } from '../common/PageArgumentEntity'
import { CustomConfirmDialog } from '../components/Common'
import { customVibrator } from "../utils/VibratorUtil"
import { common } from '@kit.AbilityKit'
import { configShare } from '../utils/SystemShareUtil'
// XXX æµ‹è¯•ç”¨ åˆ é™¤
import { showFileNameListOfFileDir } from '../utils/FileUtil'
import { fileIo as fs } from '@kit.CoreFileKit'
import { Decimal } from '@kit.ArkTS'


/**
 * é•¿æŒ‰èœå•å‚æ•°
 */
interface LongPressContextMenuItem {
  symbolStartIcon?: SymbolGlyphModifier,
  symbolEndIcon?: SymbolGlyphModifier,
  content: ResourceStr
  callback : Callback<void>
}


@Entry
@Component
struct ConfigurationPage {

  private componentName:string = 'ConfigurationPage'
  private context = getContext() as common.UIAbilityContext

  // è·å–åº”ç”¨æ²™ç®±æ–‡ä»¶è·¯å¾„
  private pathOfContextFilesDir = this.context.filesDir

  /* ä¸»é¢˜è‰² */
  @Consume('icon_emphasize')
  icon_emphasize: ResourceColor

  private promptAction:PromptAction = this.getUIContext()?.getPromptAction()

  /* æ˜¯å¦å¼€å¯ `Index` é¡µé¢çš„å‰æ™¯æ¨¡ç³Š */
  @Consume('isEnableIndexForegroundBlur')
  private isEnableIndexForegroundBlur: boolean

  /* æ–­ç‚¹å¸ƒå±€ç›¸å…³ ç›¸å…³ä½œç”¨çœ‹å®šä¹‰æ—¶å€™çš„æ³¨é‡Š */
  @Consume('breakPointStateListLanes')
  private breakPointStateListLanes: BreakpointState<number>
  @Consume('breakPointStateListGutter')
  private breakPointStateListGutter: BreakpointState<number>
  @Consume('breakPointStateTabContentTitleMargin')
  private breakPointStateTabContentTitleMargin: BreakpointState<number>

  /* å½“å‰è®¾å¤‡`height`æ˜¯å¦ç¬¦åˆ(320vp< height <= 500vp) */
  @StorageProp('isLandscapePhone')
  private isLandscapePhone: boolean = false

  /* NVè·¯ç”± ç›¸å…³ */
  // è·¯ç”±æ ˆ
  @Provide('configAddPageInfos')
  private configAddPageInfos: NavPathStack = new NavPathStack()

  /* é…ç½®åˆ—è¡¨Listç›¸å…³ */
  // å½“å‰å•é€‰æ¡†é€‰æ‹©çš„é…ç½® TODO å¾…æ¥å…¥ç”¨æˆ·é¦–é€‰é¡¹ï¼Œå…ˆå†™æ­» configNameï¼Œå•é€‰æ¡†æ§åˆ¶ç°åœ¨åªç”¨åˆ°configNameæ‰€ä»¥å…ˆä¸ç»™å€¼
  // @StorageProp('currentConfigRadioCheckedConfigData')
  @State
  private currentConfigRadioCheckedConfigData: ConfigData = {
    configId: '',
    isNewConfig: false,
    configName: 'VMess-TikTokä¸“ç”¨',
    configURL: '',
    isConfigAutoUpdate: false
  }
  /**
   * XXX å½“å‰æ‰‹æŒ‡è§¦æ‘¸çš„ListItemçš„å¯¹åº” `this.configList` ä¸­çš„ `configName`
   *    Listçš„é•¿æŒ‰èœå•ä¸­çš„å“åº”éƒ½æ˜¯æ ¹æ®è¿™ä¸ªçš„å¯¹è±¡ä¸­çš„å±æ€§æ¥å¤„ç†çš„ï¼Œæ˜¯ä¸ªä¸ç¨³å®šå› ç´ 
   */
  private currentTouchConfigData: ConfigData = {
    configId: '',
    isNewConfig: false,
    configName: '',
    configURL: '',
    isConfigAutoUpdate: false
  }

  /* é…ç½®é¡µé¢å†…ListItemé•¿æŒ‰ContextMenuç›¸å…³ */
  // TODO åˆ é™¤ ä¸´æ—¶æ¨¡æ‹Ÿæ•°æ®é…ç½®åˆ—è¡¨æ•°æ®
  @State
  private configList: Array<ConfigData> = [
    {
      configId: 'SS-Youtubeé€Ÿåº¦å¿«',
      isNewConfig: false,
      configName: 'SS-Youtubeé€Ÿåº¦å¿«',
      configURL: 'https://aaa.com:8344',
      isConfigAutoUpdate: true,
      configAutoUpdateTimeGapValue: 10,
      configAutoUpdateTimeGapTextPickerIndex: 1,
      createdDate: new Date('2024-05-21 21:21:21'),
      lastUpdateDateTime: new Date('2024-12-18 17:51:00'),
      trafficUsed: '1329.43GB',
      trafficTotal: '5000GB',
      isFavorite: false,
      source: ConfigDataSource.URL,
    },
    {
      configId: 'Trojan-INSä¸“ç”¨',
      isNewConfig: false,
      configName: 'Trojan-INSä¸“ç”¨',
      configURL: 'http://ealion.com/ins-test',
      isConfigAutoUpdate: true,
      configAutoUpdateTimeGapValue: 233,
      configAutoUpdateTimeGapTextPickerIndex: 0,
      createdDate: new Date('2023-12-20 04:14:35'),
      lastUpdateDateTime: new Date('2024-12-18 15:00:00'),
      trafficUsed: '234.42GB',
      trafficTotal: '700GB',
      isFavorite: true,
      source: ConfigDataSource.QR_CODE,
    },
    {
      configId: 'VMess-TikTokä¸“ç”¨',
      isNewConfig: false,
      configName: 'VMess-TikTokä¸“ç”¨',
      configURL: 'https://enlin.com:2333',
      isConfigAutoUpdate: false,
      createdDate: new Date('2024-06-16 12:34:56'),
      lastUpdateDateTime: new Date('2024-12-18 12:00:00'),
      trafficUsed: '874.04GB',
      trafficTotal: '2000GB',
      isFavorite: true,
      source: ConfigDataSource.COPY,
    },
    {
      configId: 'VMess-TGä¸“ç”¨',
      isNewConfig: false,
      configName: 'VMess-TGä¸“ç”¨',
      configURL: 'https://telegram-vmess.enlin.com',
      isConfigAutoUpdate: true,
      configAutoUpdateTimeGapValue: 7,
      configAutoUpdateTimeGapTextPickerIndex: 2,
      createdDate: new Date('2024-01-01 12:24:34'),
      lastUpdateDateTime: new Date('2024-12-19 08:00:00'),
      trafficUsed: '34.05GB',
      trafficTotal: '800GB',
      isFavorite: false,
      source: ConfigDataSource.QR_CODE,
    },
  ]

  // ContextMenu æ”¶è—&å–æ¶ˆæ”¶è—åˆ—è¡¨é¡¹é›†åˆ
  // private configListLongPressCtxMenusForFavorite: Array<LongPressContextMenuItem> = []
  // ContextMenu åˆ—è¡¨é¡¹ åŠ¨æ€æ›¿æ¢ç”¨
  private configListLongPressCtxMenuForUnFavorite: LongPressContextMenuItem = {
    symbolStartIcon: new SymbolGlyphModifier($r('sys.symbol.star_fill'))
      .fontSize(TAB_CONTENT_TITLE_SYMBOL_FONT_SIZE).fontColor([$r('sys.color.multi_color_11')]),
    content: 'å–æ¶ˆæ”¶è—', callback: ()=>{ this.cancelFavoriteConfig() }
  }
  private configListLongPressCtxMenuForFavorite: LongPressContextMenuItem = {
    symbolStartIcon: new SymbolGlyphModifier($r('sys.symbol.star'))
      .fontSize(TAB_CONTENT_TITLE_SYMBOL_FONT_SIZE).fontColor([$r('sys.color.font_primary')]),
    content: 'æ”¶è—', callback: ()=>{ this.favoriteConfig() }
  }
  // ContextMenuåˆ—è¡¨é¡¹é›†åˆ TODO å›½é™…åŒ–
  private configListLongPressCtxMenus: Array<LongPressContextMenuItem> = [
    // { symbolStartIcon: new SymbolGlyphModifier($r('sys.symbol.star'))
    //     .fontSize(TAB_CONTENT_TITLE_SYMBOL_FONT_SIZE).fontColor([$r('sys.color.font_primary')]),
    //   content: 'æ”¶è—', callback: ()=>{this.favoriteConfig()}
    // },
    { symbolStartIcon: new SymbolGlyphModifier($r('sys.symbol.square_and_pencil'))
        .fontSize(TAB_CONTENT_TITLE_SYMBOL_FONT_SIZE).fontColor([$r('sys.color.font_primary')]),
      content: 'ç¼–è¾‘', callback: ()=>{this.editConfig()}
    },
    { symbolStartIcon: new SymbolGlyphModifier($r('sys.symbol.arrow_clockwise'))
        .fontSize(TAB_CONTENT_TITLE_SYMBOL_FONT_SIZE).fontColor([$r('sys.color.font_primary')]),
      content: 'æ›´æ–°', callback: ()=>{this.updateConfig(this.currentTouchConfigData.configId)}
    },
    { symbolStartIcon: new SymbolGlyphModifier($r('sys.symbol.share'))
        .fontSize(TAB_CONTENT_TITLE_SYMBOL_FONT_SIZE).fontColor([$r('sys.color.font_primary')]),
      content: 'åˆ†äº«é“¾æ¥', callback: ()=>{this.shareConfigURL()}
    },
    { symbolStartIcon: new SymbolGlyphModifier($r('sys.symbol.qrcode'))
        .fontSize(TAB_CONTENT_TITLE_SYMBOL_FONT_SIZE).fontColor([$r('sys.color.font_primary')]),
      content: 'ç”ŸæˆäºŒç»´ç ', callback: ()=>{this.generateQRcode()}
    },
    { symbolStartIcon: new SymbolGlyphModifier($r('sys.symbol.doc_text'))
      .fontSize(TAB_CONTENT_TITLE_SYMBOL_FONT_SIZE).fontColor([$r('sys.color.font_primary')]),
      content: 'å¯¼å‡ºé…ç½®æ–‡ä»¶', callback: ()=>{this.generateQRcode()}
    },
    { symbolStartIcon: new SymbolGlyphModifier($r('sys.symbol.plus_square_on_square'))
      .fontSize(TAB_CONTENT_TITLE_SYMBOL_FONT_SIZE).fontColor([$r('sys.color.font_primary')]),
      content: 'åˆ›å»ºå‰¯æœ¬', callback: ()=>{this.generateQRcode()}
    },
  ]
  // é…ç½®é¡µé¢ListItemçš„é•¿æŒ‰ContextMenuçš„Builder
  @Builder
  configListLongPressCtxMenuBuilder(isFavorite:boolean) {
    // å½“èœå•è¿‡å¤šï¼ˆæ¨ªå±æ—¶ï¼‰ï¼Œè‡ªèº«çš„æ»šåŠ¨æ¡ä¸æ”¯æŒå›å¼¹ï¼Œå¥—ä¸€å±‚Scroll
    Scroll(){
      Menu() {
        // æ ¹æ®å½“å‰é…ç½®ä¿¡æ¯æ¥åˆ¤æ–­æ˜¾ç¤º[æ”¶è— /å–æ¶ˆæ”¶è—] å•ç‹¬å¤„ç† START
        if (isFavorite) {
          MenuItem({
            symbolStartIcon: this.configListLongPressCtxMenuForUnFavorite.symbolStartIcon!
              .fontSize(TAB_CONTENT_TITLE_SYMBOL_FONT_SIZE),
            content: this.configListLongPressCtxMenuForUnFavorite.content
          })
            .clickEffect({level: ClickEffectLevel.MIDDLE})
            .contentFontColor($r('sys.color.font_primary'))
            .onClick( () => {
              this.configListLongPressCtxMenuForUnFavorite.callback()
            })
        } else {
          MenuItem({
            symbolStartIcon: this.configListLongPressCtxMenuForFavorite.symbolStartIcon!
              .fontSize(TAB_CONTENT_TITLE_SYMBOL_FONT_SIZE),
            content: this.configListLongPressCtxMenuForFavorite.content
          })
            .clickEffect({level: ClickEffectLevel.MIDDLE})
            .contentFontColor($r('sys.color.font_primary'))
            .onClick( () => {
              this.configListLongPressCtxMenuForFavorite.callback()
            })
        }
        // æ ¹æ®å½“å‰é…ç½®ä¿¡æ¯æ¥åˆ¤æ–­æ˜¾ç¤º[æ”¶è— /å–æ¶ˆæ”¶è—] å•ç‹¬å¤„ç† END

        // éå†å…¶ä»–èœå• START
        ForEach(this.configListLongPressCtxMenus, (item: LongPressContextMenuItem, index: number) => {
          MenuItem({ symbolStartIcon: item?.symbolStartIcon, content: item?.content })
            .clickEffect({level: ClickEffectLevel.MIDDLE})
            .contentFontColor($r('sys.color.font_primary'))
            .onClick( () => {
              // hilog.info(0xC002, this.componentName, `#configListLongPressCtxMenuBuilder#onClick():`)
              item.callback()
            })
        })
        // éå†å…¶ä»–èœå• END

        // åˆ é™¤é…ç½® æ–‡å­—çº¢è‰² å•ç‹¬å¤„ç† START
        // åˆ é™¤é…ç½® æ–‡å­—çº¢è‰² å•ç‹¬å¤„ç† START
        MenuItem({
          symbolStartIcon: new SymbolGlyphModifier($r('sys.symbol.trash_fill'))
            .fontSize(TAB_CONTENT_TITLE_SYMBOL_FONT_SIZE)
            .fontColor(['#E6E54E36']),
          // TODO å›½é™…åŒ–
          content: 'åˆ é™¤'
        })
          .clickEffect({level: ClickEffectLevel.MIDDLE})
          .contentFontColor('#E6E54E36')
          .onClick( () => {
            this.configCustomDialogController?.open()
            this.isEnableIndexForegroundBlur = true
          })
        // åˆ é™¤é…ç½® æ–‡å­—çº¢è‰² å•ç‹¬å¤„ç† END
      }
      .backgroundColor($r('app.color.container_background'))
      .borderRadius(BORDER_RADIUS_20)
      .menuItemDivider({ strokeWidth: LengthMetrics.vp(.4), color: $r('sys.color.comp_divider') })
      .width(200)
      .height('auto')
      .transition(TransitionEffect.asymmetric(TransitionEffect.move(TransitionEdge.END), TransitionEffect.move(TransitionEdge.START))
        .animation({ duration: ANIMATION_DURATION_300, curve: Curve.Ease })
        .combine(TransitionEffect.OPACITY)
      )
    }
    .nestedScroll({scrollForward: NestedScrollMode.SELF_FIRST, scrollBackward: NestedScrollMode.SELF_FIRST})
    .edgeEffect(EdgeEffect.Spring)
  }
  /* è‡ªå®šä¹‰å¼¹æ¡† */
  // é…ç½®æ˜¯å¦ä¿å­˜å¼¹æ¡† Controllerå®šä¹‰
  private configCustomDialogController: CustomDialogController | null= new CustomDialogController({
    builder: CustomConfirmDialog({
      // TODO å›½é™…åŒ–
      title: 'æ˜¯å¦åˆ é™¤å½“å‰é…ç½®ï¼Ÿ',
      cancelText: 'åˆ é™¤',
      confirmText: 'å–æ¶ˆ',
      cancelButtonBackgroundColor: Color.Transparent,
      // ä¸å¯ä»¥ä½¿ç”¨`@Consume`æ³¨è§£çš„å˜é‡
      // confirmButtonBackgroundColor: this.icon_emphasize,
      cancel: () => {
        this.isEnableIndexForegroundBlur = false
        // TODO å›½é™…åŒ–
        this.promptAction.showToast({ message: `å°±çŸ¥é“æ˜¯ä½ ç‚¹é”™å–½~` })
      },
      confirm: ()=> {
        this.isEnableIndexForegroundBlur = false
        this.deleteConfig()
      }
    }),
    cancel: () => {
      this.isEnableIndexForegroundBlur = false
    },
    autoCancel: true,
    alignment: DialogAlignment.Center,
    width: 328,
    backgroundColor: $r('app.color.list_item_background_color'),
  })

  /* Stackå±‚å å¸ƒå±€ */
  // æ‰€æœ‰å­ç»„ä»¶åœ¨å®¹å™¨å†…çš„å¯¹é½æ–¹å¼ TODO ã€ç”¨æˆ·é¦–é€‰é¡¹ã€‘åœ¨è®¾ç½®é‡Œå¯ä»¥æ›´æ”¹ Alignment.BottomStart å’Œ Alignment.BottomEnd Enlin@2024-12-04

  /* é…ç½®æ·»åŠ æŒ‰é’®bindSheetç›¸å…³ */
  // æŒ‰é’®åœ¨Stackå¸ƒå±€é‡Œçš„ä½ç½®
  @State
  stackAlignContentAlignment: Alignment = Alignment.BottomEnd
  // æ˜¯å¦æ˜¾ç¤ºbindSheet
  @State
  private isShowConfigAddBindSheet: boolean = false
  // æ˜¯å¦éœ€è¦å¾€`bindSheet`é‡Œ`push`è·¯ç”±é¡µé¢
  private isPushRoute2BindSheet: boolean = false
  // å†…å®¹Builder
  @Builder
  private ConfigAddBindSheetBuilder(){
    ConfigAdd()
  }

  /* é¡µé¢å¸ƒå±€ç›¸å…³ */
  // é…ç½®æ·»åŠ æŒ‰é’®å®½åº¦
  private proxyStartButtonWidth: Length = $r('app.integer.vp_proxy_not_start_button_width')
  // é…ç½®æ·»åŠ æŒ‰é’®é«˜åº¦
  private proxyStartButtonHeight: Length = $r('app.integer.vp_proxy_not_start_button_height')
  // é…ç½®æ·»åŠ æŒ‰é’®Margin
  private proxyStartButtonMargin: Length = $r('app.integer.vp_proxy_start_button_margin')
  // é…ç½®æ·»åŠ æŒ‰é’®å‰SymbolåŠ¨æ•ˆ
  private ReplaceSymbolEffect: SymbolEffect = EffectScope.WHOLE


  build() {
    Column() {
      // æ ‡é¢˜æ  START
      if (!this.isLandscapePhone) {
        Row() {
          Text($r('app.string.Configuration'))
            .fontSize(TAB_CONTENT_TITLE_FONT_SIZE)
            .fontWeight(TAB_CONTENT_TITLE_FONT_WEIGHT)
            .fontColor($r('sys.color.font_primary'))
          Blank()
          // åˆ·æ–°å›¾æ ‡
          Button({ type: ButtonType.Circle, stateEffect: true }) {
            SymbolGlyph($r('sys.symbol.arrow_clockwise'))
              .fontSize(TAB_CONTENT_TITLE_SYMBOL_FONT_SIZE)
              .fontColor([$r('sys.color.icon_primary')])
          }
          .width(40)
          .height(40)
          .backgroundColor($r('app.color.settings_container_background'))
          .clickEffect({ level: ClickEffectLevel.LIGHT })
          .onClick(() => {
            // TODO å›½é™…åŒ–é€‚é… æ›´æ–°é…ç½®ä¸­... æ›´æ–°é…ç½®æˆåŠŸ
            // TODO è°ƒç”¨ æ›´æ–°é…ç½®api
            hilog.info(0xC001, this.componentName, `#button#onClick()#æ›´æ–°é…ç½®`)
            this.updateConfig()
            // XXX åˆ é™¤ æµ‹è¯•ç”¨ è·å–æŒ‡å®šåº”ç”¨æ²™ç®±[è·¯å¾„]ä¸‹çš„æ‰€æœ‰æ–‡ä»¶å
            let fileNames = showFileNameListOfFileDir(this.context.filesDir)
            // è¾“å‡ºæ–‡ä»¶ä¿¡æ¯
            fileNames.forEach( (fileName: string) => {
              const fileStat: fs.Stat = fs.statSync(`${this.context.filesDir}/${fileName}`)
              hilog.info(0x1020, this.componentName, `#showFileNameListOfFileDir#â€œ${this.context.filesDir}â€æ–‡ä»¶å¤¹ä¸‹æ–‡ä»¶â€œ${fileName}â€çš„å¤§å°ä¸º: ${fileStat.size}Byte = ${Decimal.div(fileStat.size, 1024).toFixed(2, Decimal.ROUND_DOWN)}KB`)
            })
          })
        }
        .alignItems(VerticalAlign.Center)
        .width('100%')
        .height(TAB_CONTENT_TITLE_HEIGHT)
        .padding({
          left: this.breakPointStateTabContentTitleMargin.value,
          right: this.breakPointStateTabContentTitleMargin.value,
        })
        // .margin({ bottom: 15 })
      }
      // æ ‡é¢˜æ  END

      // ä¸»ä½“ START
      Stack({ alignContent: this.stackAlignContentAlignment }) {
        // é…ç½®åˆ—è¡¨ START
        List({ space: LIST_SPACE }) {
          ForEach(this.configList, (item: ConfigData, index: number) => {
            ListItem() {
              Row() {
                Column() {
                  Text(item.configName).fontColor(($r('sys.color.font_primary')))
                  Text(`index:${index}`).fontColor($r('sys.color.font_secondary'))
                }.alignItems(HorizontalAlign.Start)
                Blank()
                Radio({ value: 'radio' + index, group: 'configGroup' })
                  .checked(item.configName === this.currentConfigRadioCheckedConfigData.configName)
                  .radioStyle({
                    checkedBackgroundColor: this.icon_emphasize,
                  })
              }
              .width('100%')
              .padding(LIST_ITEM_PADDING)
              .alignItems(VerticalAlign.Center)
            }
            .backgroundColor($r('app.color.container_background'))
            .width('100%')
            .height(LIST_ITEM_HEIGHT)
            .clickEffect({ level: ClickEffectLevel.MIDDLE })
            .borderRadius(BORDER_RADIUS_20)
            .hoverEffect(HoverEffect.Scale)
            .bindContextMenu(this.configListLongPressCtxMenuBuilder(item?.isFavorite ?? false), ResponseType.LongPress | ResponseType.RightClick,
              {
                preview: MenuPreviewMode.IMAGE,
                previewAnimationOptions: { scale: [1.0, 1.1] },
                placement: Placement.BottomRight,
                aboutToAppear: () => {
                  customVibrator.vibratorTriggerOfHapticClockTimer()
                }
              })
            .onClick(() => {
              this.currentConfigRadioCheckedConfigData = item
              customVibrator.vibratorTriggerOfHapticClockTimer()
              hilog.info(0xC002, this.componentName, `#ListItem#onClick:configName is [${this.currentConfigRadioCheckedConfigData.configName}]`)
            })
            .onTouch((event: TouchEvent) => {
              if (event.type === TouchType.Down) {
                // TODO ç°åœ¨ç”¨æ¥ä»£æ›¿è·å–é•¿æŒ‰çš„æ˜¯å“ªä¸€ä¸ªListItemï¼Œç›®å‰ç”¨`configName`ä½œä¸ºæ¯ä¸€ä¸ªitemçš„å”¯ä¸€æ€§å±æ€§
                this.currentTouchConfigData = item
                hilog.info(0xC002, this.componentName, `#ListItem#onTouch(TouchType.Down): configName is [${this.currentTouchConfigData.configName}]`)
              }
            })
            // .gesture(LongPressGesture({ repeat: false }).onAction(() => {
            //   this.isShownConfigListCtxMenu = !this.isShownConfigListCtxMenu
            //   hilog.info(0xC002, this.componentName, `#gesture#LongPressGesture:`)
            // }))
          })
        }
        .width('100%')
        .height('100%')
        .padding({
          left: this.breakPointStateTabContentTitleMargin.value,
          right: this.breakPointStateTabContentTitleMargin.value,
        })
        // 110 = app.integer.vp_proxy_start_button_margin *2 + app.integer.vp_proxy_not_start_button_width
        .contentEndOffset(110)
        .lanes(this.breakPointStateListLanes.value, this.breakPointStateListGutter.value)
        .edgeEffect(EdgeEffect.Spring, { alwaysEnabled: true })
        .chainAnimation(true)
        // é…ç½®åˆ—è¡¨ END

        // æ‚¬æµ®æ–°å¢é…ç½®æŒ‰é’® START
        Column() {
          Stack({ alignContent: Alignment.Center }) {
            SymbolGlyph($r('sys.symbol.plus'))
              .fontSize(TAB_CONTENT_TITLE_SYMBOL_FONT_SIZE)
              .fontColor([Color.White])
              .symbolEffect(this.ReplaceSymbolEffect)
              .align(Alignment.Center)
          }
          .width('100%')
          .height('100%')
        }
        // .backgroundColor($r('app.color.speed_down_icon'))
        .shadow({
          radius: 10,
          color: $r('app.color.speed_down_icon'),
          offsetY: 4,
          type: ShadowType.BLUR
        })
        .borderRadius(100)
        .margin(this.proxyStartButtonMargin)
        .width(this.proxyStartButtonWidth)
        .height(this.proxyStartButtonHeight)
        .backgroundColor(this.icon_emphasize)
        .clip(true)
        .animation({ duration: ANIMATION_DURATION_300, curve: Curve.Ease })
        .clickEffect({ level: ClickEffectLevel.LIGHT })
        .hoverEffect(HoverEffect.Scale)
        .bindSheet( this.isShowConfigAddBindSheet, this.ConfigAddBindSheetBuilder, {
          // title: { title: $r('app.string.AddConfig') },
          detents: [BIND_SHEET_CONTAINER_HEIGHT, SheetSize.FIT_CONTENT, ],// SheetSize.LARGE
          // backgroundColor: $r('app.color.container_background'),
          backgroundColor: $r('app.color.background'),
          showClose: true,
          dragBar: false,
          preferType: SheetType.CENTER,
          // blurStyle: BlurStyle.COMPONENT_ULTRA_THICK,
          // blurStyle: BlurStyle.BACKGROUND_REGULAR,
          scrollSizeMode: ScrollSizeMode.CONTINUOUS,
          // width: ('100%'),
          /**
           * åŠæ¨¡æ€é¡µé¢æ˜¾ç¤ºï¼ˆåŠ¨ç”»å¼€å§‹å‰ï¼‰å›è°ƒå‡½æ•°
           *    ç›®å‰`é€šè¿‡URL(é“¾æ¥)å¯¼å…¥`å’Œ`é•¿æŒ‰é…ç½®ç¼–è¾‘`æ˜¯ç”¨çš„åŒä¸€ä¸ªé¡µé¢ï¼Œ
           *    è¿™é‡Œä¸»è¦æ˜¯ç”¨æ¥å¤„ç†æ‹‰èµ·`bindSheet`ä¹‹åå¯ä»¥ç­‰`bindSheet`æ¸²æŸ“å®Œæ¯•ä¹‹åæ­£ç¡®ä¼ å…¥è·¯ç”±ä¿¡æ¯
           */
          onWillAppear: () => {
            hilog.info(0xC020, this.componentName, `#button#bindSheet#onWillAppear() executed`)
            if (this.isPushRoute2BindSheet) {
              this.pushEditConfigRoute2BindSheet()
              this.isPushRoute2BindSheet = false
            }
          },
          // åŠæ¨¡æ€é¡µé¢äº¤äº’å¼å…³é—­å›è°ƒå‡½æ•°
          onWillDismiss: (dismissSheet :DismissSheetAction) => {
          // åœ¨äºŒçº§è·¯ç”±é¡µé¢å†…åªèƒ½é€šè¿‡ç‚¹å‡»å…³é—­æŒ‰é’®æ‰èƒ½å…³æ‰bindSheet
            if (this.configAddPageInfos.size() <= 0 || (dismissSheet.reason === DismissReason.CLOSE_BUTTON)) {
              dismissSheet.dismiss()
              this.isShowConfigAddBindSheet = false
              this.isEnableIndexForegroundBlur = false
              this.configAddPageInfos.clear(true)
              hilog.info(0xC020, this.componentName, `#button#bindSheet#onWillDismiss()#å…³é—­é…ç½®æ·»åŠ æŒ‰é’®çš„bindSheetï¼šDismissSheetAction.dismiss()`)
            }
          },
          onWillSpringBackWhenDismiss: (springBack: SpringBackAction)=> {
            springBack.springBack()
          }
        })
        .onClick( () => {
          this.isShowConfigAddBindSheet = true
          this.isEnableIndexForegroundBlur = true
        })
        // æ‚¬æµ®æ–°å¢é…ç½®æŒ‰é’® END
      }
      .backgroundColor($r('app.color.background'))
      // .padding(this.isLandscapePhone ? '0vp' : { bottom: '45vp' })
      .width('100%')
      .height(this.isLandscapePhone ? '100%' :`calc(100% - ${TAB_CONTENT_TITLE_HEIGHT}vp)`)
      // ä¸»ä½“ END
    }
    .width('100%')
    .height('100%')
    .animation({ duration: ANIMATION_DURATION_300, curve: Curve.Linear, delay: 0 })
  }

  aboutToAppear(): void {
    hilog.info(0xC000, this.componentName, `#aboutToAppear executed`)
    let fileNames: Array<string> = showFileNameListOfFileDir(this.context.filesDir)
    // XXX åˆ é™¤ è¿™é‡Œæ¨¡æ‹Ÿè·å–URLä¸‹è½½çš„åˆ—è¡¨
    fileNames.forEach( (fileName:string) => {
      let newConfig: ConfigData = {
        configId: fileName.slice(0, fileName.length - 5),
        isNewConfig: false,
        configName: fileName.slice(0, fileName.length - 5),
        configURL: 'https://www.gov.cn/',
        isConfigAutoUpdate: false
      }
      this.configList.push(newConfig)
    })
  }

  aboutToDisappear(): void {
    hilog.info(0xC000, this.componentName, `#aboutToDisappear executed`)
    this.configCustomDialogController = null
    this.isEnableIndexForegroundBlur = false
    hilog.info(0xC000, this.componentName, `#aboutToDisappear#ç½®ç©º[é…ç½®é¡µ\`bindSheet\`å†…æç¤ºæ˜¯å¦åˆ é™¤é…ç½®ä¿¡æ¯çš„è‡ªå®šä¹‰å¼¹æ¡†]`)
  }

  /**
   * é¡µé¢å†…é€šç”¨ `é…ç½®NVè·¯ç”±` pushæ–¹æ³•
   * @param routeName å°†è¦è·¯ç”±çš„é¡µé¢åç§°
   * @param param     è·¯ç”±å‚æ•°
   * @param animated  æ˜¯å¦å¯ç”¨è½¬åœºåŠ¨ç”»
   */
  pushDestinationByName(routeName: RouteName, param: Object | null, animated?: boolean): void {
    this.configAddPageInfos.pushDestinationByName(routeName, param, animated)
    hilog.info(0xC000, this.componentName, `#pushDestinationByName#NavPathStack.pushDestinationByName(${routeName}, ${JSON.stringify(param)}, ${animated})`)

  }

  /**
   * æ‹‰èµ·é…ç½®ç¼–è¾‘é¡µ å¹¶ä¼ å‚
   */
  private pushEditConfigRoute2BindSheet(){
    this.pushDestinationByName(RouteName.IMPORT_CONFIG_FROM_URL, this.currentTouchConfigData)
  }

  /**
   * æ”¶è—é…ç½®
   */
  private favoriteConfig(): void {
    // TODO æ”¶è—é…ç½® & åˆ¤æ–­æ˜¯å¦å·²ç»æ”¶è—
    this.promptAction.showToast({ message: $r('app.string.Collect_Tip') })
    hilog.info(0xC010, this.componentName, `#favoriteConfig#æ”¶è—é…ç½®: configName is [${this.currentTouchConfigData.configName}]`)
    this.currentTouchConfigData.isFavorite = true
  }
  /**
   * å–æ¶ˆæ”¶è—é…ç½®
   */
  private cancelFavoriteConfig(): void {
    // TODO å–æ¶ˆæ”¶è—é…ç½® & åˆ¤æ–­æ˜¯å¦å·²ç»æ”¶è—
    this.promptAction.showToast({ message: $r('app.string.uncollected_tip') })
    hilog.info(0xC010, this.componentName, `#favoriteConfig#å–æ¶ˆæ”¶è—é…ç½®: configName is [${this.currentTouchConfigData.configName}]`)
    this.currentTouchConfigData.isFavorite = false
  }
  /**
   * ç¼–è¾‘é…ç½®
   */
  private editConfig(): void {
    // TODO ç¼–è¾‘bindSheet
    hilog.info(0xC011, this.componentName, `#editConfig#ç¼–è¾‘é…ç½®: configName is [${this.currentTouchConfigData.configName}]`)
    this.isShowConfigAddBindSheet = true
    this.isPushRoute2BindSheet = true
  }
  /**
   * æ›´æ–°é…ç½®
   */
  private updateConfig(configId?: string): void {
    // TODO è°ƒç”¨æ›´æ–°é…ç½®æ¶ˆæ¯api
    this.promptAction.showToast({message: `é…ç½®æ›´æ–°ä¸­...`})
    if (configId){
      // TODO å•ä¸ªé…ç½®æ›´æ–°
      hilog.info(0xC012, this.componentName, `#updateConfig#æ›´æ–°é…ç½®{å•ä¸ª}: configName is [${this.currentTouchConfigData.configName}], configId is [${this.currentTouchConfigData.configId}]`)
    } else {
      // TODO æ‰€æœ‰é…ç½®æ›´æ–°
      hilog.info(0xC012, this.componentName, `#updateConfig#æ›´æ–°é…ç½®{æ‰€æœ‰}`)
    }
  }
  /**
   * åˆ†äº«é…ç½®çš„URL
   */
  private shareConfigURL(): void {
    // TODO å¤„ç†å¾…åˆ†äº«æ•°æ® å¹¶è°ƒç”¨ç³»ç»Ÿåˆ†äº«æ¥å£ åªæœ‰URLå¯¼å…¥çš„é…ç½®æ‰å¯ä»¥åˆ†äº«é“¾æ¥
    hilog.info(0xC013, this.componentName, `#shareConfig#åˆ†äº«é…ç½®: configName is [${this.currentTouchConfigData.configName}]`)
    let systemShareResult: boolean = configShare(this.context, this.currentTouchConfigData.configURL, this.currentTouchConfigData.configId)
    if (!systemShareResult) {
      this.promptAction.showToast({ message: `åˆ†äº«é”™è¯¯ï¼Œè¯·è”ç³»å¼€å‘è€…ï¼ğŸ›` })
    }
  }
  /**
   * ç”Ÿæˆé…ç½®çš„URLè½¬æˆçš„äºŒç»´ç 
   *    1. URL & äºŒç»´ç  å¯¼å…¥çš„é…ç½®ç”¨å¯¹åº”URLç”ŸæˆäºŒç»´ç 
   *    2. å…¶ä»–æ–¹å¼å¯¼å…¥çš„é…ç½®ä¸èƒ½ç”ŸæˆäºŒç»´ç 
   */
  private generateQRcode(): void {
    // TODO å¼¹æ¡†CustomDialogï¼Œåœ¨å…¶ä¸­å®ç°â€œé…ç½®urlâ€ç”ŸæˆäºŒç»´ç çš„åŠŸèƒ½
    hilog.info(0xC014, this.componentName, `#generateQRcode#ç”ŸæˆäºŒç»´ç : configName is [${this.currentTouchConfigData.configName}]`)
  }
  /**
   * å¯¼å‡ºé…ç½®
   */
  private exportConfig(): void {
    // TODO åˆ é™¤ç”¨æˆ·é¦–é€‰é¡¹é‡Œçš„æ­¤é…ç½®
    hilog.info(0xC015, this.componentName, `#deleteConfig#åˆ é™¤é…ç½®: configName is [${this.currentTouchConfigData.configName}]`)
  }
  /**
   * åˆ é™¤é…ç½®
   */
  private deleteConfig(): void {
    // TODO åˆ é™¤ç”¨æˆ·é¦–é€‰é¡¹é‡Œçš„æ­¤é…ç½®
    this.promptAction.showToast({ message: `å·²åˆ é™¤é…ç½®ğŸ’”` })
    hilog.info(0xC016, this.componentName, `#deleteConfig#åˆ é™¤é…ç½®: configName is [${this.currentTouchConfigData.configName}]`)
  }

}


export default ConfigurationPage