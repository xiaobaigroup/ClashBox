import { BreakpointState } from '../common/breakpointsystem'
import {
  TAB_CONTENT_TITLE_FONT_SIZE,
  TAB_CONTENT_TITLE_FONT_WEIGHT,
  TAB_CONTENT_TITLE_HEIGHT,
  TAB_CONTENT_TITLE_SYMBOL_FONT_SIZE,
  LIST_ITEM_HEIGHT,
  LIST_SPACE,
  BORDER_RADIUS_20,
  BIND_SHEET_CONTAINER_HEIGHT,
  LIST_ITEM_PADDING,
  RouteName,
  CONTENT_END_OFFSET_150,
} from '../common/Constants'
import { curves, LengthMetrics, promptAction, PromptAction, SymbolGlyphModifier } from '@kit.ArkUI'
import { ConfigAdd } from '../components/Configuration/ConfigAdd'
import { hilog } from '@kit.PerformanceAnalysisKit'
import { Callback } from '@ohos.base'
import { ConfigData, ConfigDataSourceType } from '../common/PageArgumentEntity'
import { cellularData, CustomConfirmDialog, Nothing, RightDownButton } from '../components/Common'
import { customVibrator } from "../utils/VibratorUtil"
import { common } from '@kit.AbilityKit'
import { configShare } from '../utils/SystemShareUtil'
// XXX æµ‹è¯•ç”¨ åˆ é™¤
import { showFileNameListOfFileDir } from '../utils/FileUtil'
import ClashViewModel from '../entryability/ClashViewModel'
import { AppConfig, UIConfig } from '../entryability/AppState'
import { EventHub, EventKey } from '../common/EventHub'
import { getResourceString } from '../utils/ResourceStringUtil'
import { convertTime } from '../utils/TimeConvertUtil'
import { customAnimationUtil, isON } from '../utils/Animation'
import { Profile, ProxyGroup, SubscriptionInfo } from 'proxy_core'
import { Provider } from "proxy_core"
import { ProxyItem, ProxyItemDataSource } from '../common/ProxyData'
import { PopTips, PopupBuilder } from '../components/Start/Popup'


/**
 * é•¿æŒ‰èœå•å‚æ•°
 */
interface LongPressContextMenuItem {
  symbolStartIcon?: SymbolGlyphModifier,
  symbolEndIcon?: SymbolGlyphModifier,
  content: ResourceStr
  callback : Callback<void>
}


@Entry
@Component
struct ConfigurationPage {

  private componentName:string = 'ConfigurationPage'
  private context = getContext() as common.UIAbilityContext

  // è·å–åº”ç”¨æ²™ç®±æ–‡ä»¶è·¯å¾„
  private pathOfContextFilesDir = this.context.filesDir

  /* ä¸»é¢˜è‰² */
  @Consume('icon_emphasize')
  icon_emphasize: ResourceColor
  // æ‰€æœ‰å­ç»„ä»¶åœ¨å®¹å™¨å†…çš„å¯¹é½æ–¹å¼
  @Consume ('stackAlignContentAlignment') stackAlignContentAlignment: Alignment

  private promptAction:PromptAction = this.getUIContext()?.getPromptAction()

  /* æ˜¯å¦å¼€å¯ `Index` é¡µé¢çš„å‰æ™¯æ¨¡ç³Š */
  @Consume('isEnableIndexForegroundBlur')
  private isEnableIndexForegroundBlur: boolean


  /* æ–­ç‚¹å¸ƒå±€ç›¸å…³ ç›¸å…³ä½œç”¨çœ‹å®šä¹‰æ—¶å€™çš„æ³¨é‡Š */
  @Consume('breakPointStateListLanes')
  private breakPointStateListLanes: BreakpointState<number>
  @Consume('breakPointStateListGutter')
  private breakPointStateListGutter: BreakpointState<number>
  @Consume('breakPointStateTabContentTitleMargin')
  private breakPointStateTabContentTitleMargin: BreakpointState<number>

  /* å½“å‰è®¾å¤‡`height`æ˜¯å¦ç¬¦åˆ(320vp< height <= 500vp) */
  @StorageProp('isLandscapePhone')
  private isLandscapePhone: boolean = false

  @StorageLink('uiConfig') uiConfig: UIConfig = new UIConfig()
  //å¼€å…³ä¸è§¦å‘listè½¬åœºåŠ¨ç”»åˆ¤å®š
  @State isON:isON = new isON()
  //èŠ‚ç‚¹æ•°æ®ç»„
  @Prop items: ProxyItem[]
  @Consume
  proxyGroups: ProxyGroup[]
  /* NVè·¯ç”± ç›¸å…³ */
  // è·¯ç”±æ ˆ
  @Provide('configAddPageInfos')
  private configAddPageInfos: NavPathStack = new NavPathStack()
  //pageå†…é¡¶éƒ¨æ ‡é¢˜åç§»é‡
  @Consume curYOffset: number
  //loadingåŠ¨ç”»
  @State isLoading : boolean = false
  /* é…ç½®åˆ—è¡¨Listç›¸å…³ */
  // å½“å‰å•é€‰æ¡†é€‰æ‹©çš„é…ç½® TODO å¾…æ¥å…¥ç”¨æˆ·é¦–é€‰é¡¹ï¼Œå…ˆå†™æ­» configNameï¼Œå•é€‰æ¡†æ§åˆ¶ç°åœ¨åªç”¨åˆ°configNameæ‰€ä»¥å…ˆä¸ç»™å€¼
  // @StorageProp('currentConfigRadioCheckedConfigData')
  @State
  private currentConfigRadioCheckedConfigData: ConfigData = {
    configId: 'e91a4efc-cf14-467d-90c2-fec156806bfa',
    isNewConfig: false,
    configName: '',
    configUrl: '',
    isConfigAutoUpdate: false,
    lastUpdateDateTime: 0,
    updateTime: 0,
  }
  /**
   * XXX å½“å‰æ‰‹æŒ‡è§¦æ‘¸çš„ListItemçš„å¯¹åº” `this.configList` ä¸­çš„ `configId`
   *    Listçš„é•¿æŒ‰èœå•ä¸­çš„å“åº”éƒ½æ˜¯æ ¹æ®è¿™ä¸ªçš„å¯¹è±¡ä¸­çš„å±æ€§æ¥å¤„ç†çš„ï¼Œæ˜¯ä¸ªä¸ç¨³å®šå› ç´ 
   */
  private currentTouchConfigData: ConfigData = {
    configId: '',
    isNewConfig: false,
    configName: '',
    configUrl: '',
    isConfigAutoUpdate: false,
    updateTime: 0,
    lastUpdateDateTime: 0
  }

  /* é…ç½®é¡µé¢å†…ListItemé•¿æŒ‰ContextMenuç›¸å…³ */
  @Consume configList: Array<ConfigData>
  // ContextMenu æ”¶è—&å–æ¶ˆæ”¶è—åˆ—è¡¨é¡¹é›†åˆ
  // private configListLongPressCtxMenusForFavorite: Array<LongPressContextMenuItem> = []
  // ContextMenu åˆ—è¡¨é¡¹ åŠ¨æ€æ›¿æ¢ç”¨
  private configListLongPressCtxMenuForUnFavorite: LongPressContextMenuItem = {
    symbolStartIcon: new SymbolGlyphModifier($r('sys.symbol.star_fill'))
      .fontSize(TAB_CONTENT_TITLE_SYMBOL_FONT_SIZE).fontColor([$r('sys.color.multi_color_11')]),
    content: 'å–æ¶ˆæ”¶è—', callback: ()=>{ this.cancelFavoriteConfig() }
  }
  private configListLongPressCtxMenuForFavorite: LongPressContextMenuItem = {
    symbolStartIcon: new SymbolGlyphModifier($r('sys.symbol.star'))
      .fontSize(TAB_CONTENT_TITLE_SYMBOL_FONT_SIZE).fontColor([$r('sys.color.font_primary')]),
    content: 'æ”¶è—', callback: ()=>{ this.favoriteConfig() }
  }
  // ContextMenuåˆ—è¡¨é¡¹é›†åˆ
  private configListLongPressCtxMenus: Array<LongPressContextMenuItem> = [
  // { symbolStartIcon: new SymbolGlyphModifier($r('sys.symbol.star'))
  //     .fontSize(TAB_CONTENT_TITLE_SYMBOL_FONT_SIZE).fontColor([$r('sys.color.font_primary')]),
  //   content: 'æ”¶è—', callback: ()=>{this.favoriteConfig()}
  // },
    { symbolStartIcon: new SymbolGlyphModifier($r('sys.symbol.square_and_pencil'))
      .fontSize(TAB_CONTENT_TITLE_SYMBOL_FONT_SIZE).fontColor([$r('sys.color.font_primary')]),
      content: $r('app.string.Edit'), callback: ()=>{ this.editConfig() }
    },
    { symbolStartIcon: new SymbolGlyphModifier($r('sys.symbol.arrow_clockwise'))
      .fontSize(TAB_CONTENT_TITLE_SYMBOL_FONT_SIZE).fontColor([$r('sys.color.font_primary')]),
      content: $r('app.string.update'), callback: ()=>{ this.updateConfig(this.currentTouchConfigData.configId) }
    },
    { symbolStartIcon: new SymbolGlyphModifier($r('sys.symbol.share'))
      .fontSize(TAB_CONTENT_TITLE_SYMBOL_FONT_SIZE).fontColor([$r('sys.color.font_primary')]),
      content: $r('app.string.share'), callback: ()=>{ this.shareConfigUrl() }
    },
    { symbolStartIcon: new SymbolGlyphModifier($r('sys.symbol.qrcode'))
      .fontSize(TAB_CONTENT_TITLE_SYMBOL_FONT_SIZE).fontColor([$r('sys.color.font_primary')]),
      content: $r('app.string.generate_QR_code'), callback: ()=>{ this.generateQRcode() }
    },
    // XXX åˆ†äº«é“¾æ¥å’Œå¯¼å‡ºé…ç½®æ–‡ä»¶éƒ½å·²ç»é›†æˆåˆ°äº†â€œåˆ†äº«â€èœå•é‡Œ
    /*    { symbolStartIcon: new SymbolGlyphModifier($r('sys.symbol.doc_text'))
          .fontSize(TAB_CONTENT_TITLE_SYMBOL_FONT_SIZE).fontColor([$r('sys.color.font_primary')]),
          content: 'å¯¼å‡ºé…ç½®æ–‡ä»¶', callback: ()=>{ this.generateQRcode() }
        },*/
    { symbolStartIcon: new SymbolGlyphModifier($r('sys.symbol.plus_square_on_square'))
      .fontSize(TAB_CONTENT_TITLE_SYMBOL_FONT_SIZE).fontColor([$r('sys.color.font_primary')]),
      content: $r('app.string.create_copy'), callback: ()=>{ this.generateQRcode() }
    },
  ]
  // é…ç½®é¡µé¢ListItemçš„é•¿æŒ‰ContextMenuçš„Builder
  @Builder
  configListLongPressCtxMenuBuilder(isFavorite:boolean) {
    // å½“èœå•è¿‡å¤šï¼ˆæ¨ªå±æ—¶ï¼‰ï¼Œè‡ªèº«çš„æ»šåŠ¨æ¡ä¸æ”¯æŒå›å¼¹ï¼Œå¥—ä¸€å±‚Scroll
    Scroll(){
      Menu() {
        // æ ¹æ®å½“å‰é…ç½®ä¿¡æ¯æ¥åˆ¤æ–­æ˜¾ç¤º[æ”¶è— /å–æ¶ˆæ”¶è—] å•ç‹¬å¤„ç† START
        if (isFavorite) {
          MenuItem({
            symbolStartIcon: this.configListLongPressCtxMenuForUnFavorite.symbolStartIcon!
              .fontSize(TAB_CONTENT_TITLE_SYMBOL_FONT_SIZE),
            content: this.configListLongPressCtxMenuForUnFavorite.content
          })
            .clickEffect(customAnimationUtil.isClickEffect(this.uiConfig))
            .contentFontColor($r('sys.color.font_primary'))
            .onClick( () => {
              this.configListLongPressCtxMenuForUnFavorite.callback()
            })
        } else {
          MenuItem({
            symbolStartIcon: this.configListLongPressCtxMenuForFavorite.symbolStartIcon!
              .fontSize(TAB_CONTENT_TITLE_SYMBOL_FONT_SIZE),
            content: this.configListLongPressCtxMenuForFavorite.content
          })
            .clickEffect(customAnimationUtil.isClickEffect(this.uiConfig))
            .contentFontColor($r('sys.color.font_primary'))
            .onClick( () => {
              this.configListLongPressCtxMenuForFavorite.callback()
            })
        }
        // æ ¹æ®å½“å‰é…ç½®ä¿¡æ¯æ¥åˆ¤æ–­æ˜¾ç¤º[æ”¶è— /å–æ¶ˆæ”¶è—] å•ç‹¬å¤„ç† END

        // éå†å…¶ä»–èœå• START
        ForEach(this.configListLongPressCtxMenus, (item: LongPressContextMenuItem, index: number) => {
          MenuItem({ symbolStartIcon: item?.symbolStartIcon, content: item?.content })
            .clickEffect(customAnimationUtil.isClickEffect(this.uiConfig))
            .contentFontColor($r('sys.color.font_primary'))
            .onClick( () => {
              // hilog.info(0xC002, this.componentName, `#configListLongPressCtxMenuBuilder#onClick():`)
              item.callback()
            })
        })
        // éå†å…¶ä»–èœå• END

        // åˆ é™¤é…ç½® æ–‡å­—çº¢è‰² å•ç‹¬å¤„ç† START
        // åˆ é™¤é…ç½® æ–‡å­—çº¢è‰² å•ç‹¬å¤„ç† START
        MenuItem({
          symbolStartIcon: new SymbolGlyphModifier($r('sys.symbol.trash_fill'))
            .fontSize(TAB_CONTENT_TITLE_SYMBOL_FONT_SIZE)
            .fontColor(['#E6E54E36']),
          content: $r('app.string.delete')
        })
          .clickEffect(customAnimationUtil.isClickEffect(this.uiConfig))
          .contentFontColor('#E6E54E36')
          .onClick( () => {
            this.configCustomDialogController?.open()
            this.isEnableIndexForegroundBlur = true
          })
        // åˆ é™¤é…ç½® æ–‡å­—çº¢è‰² å•ç‹¬å¤„ç† END
      }
      .backgroundColor($r('app.color.container_background'))
      .borderRadius(BORDER_RADIUS_20)
      .menuItemDivider({ strokeWidth: LengthMetrics.vp(.4), color: $r('sys.color.comp_divider') })
      .width(200)
      .height('auto')
      .transition(this.uiConfig.isAnimation ? TransitionEffect.asymmetric(TransitionEffect.move(TransitionEdge.END), TransitionEffect.move(TransitionEdge.START))
        .animation({ duration: this.uiConfig.animationSpeed, curve: Curve.Ease })
        .combine(TransitionEffect.OPACITY):null
      )
    }
    .nestedScroll({scrollForward: NestedScrollMode.SELF_FIRST, scrollBackward: NestedScrollMode.SELF_FIRST})
    .edgeEffect(EdgeEffect.Spring)
  }
  /* è‡ªå®šä¹‰å¼¹æ¡† */
  // é…ç½®æ˜¯å¦ä¿å­˜å¼¹æ¡† Controllerå®šä¹‰
  private configCustomDialogController: CustomDialogController | null= new CustomDialogController({
    builder: CustomConfirmDialog({
      title: $r('app.string.delete_current_configuration'),
      cancelText: $r('app.string.delete'),
      confirmText: $r('app.string.Cancel'),
      cancelButtonBackgroundColor: Color.Transparent,
      // ä¸å¯ä»¥ä½¿ç”¨`@Consume`æ³¨è§£çš„å˜é‡
      // confirmButtonBackgroundColor: this.icon_emphasize,
      cancel: () => {
        this.isEnableIndexForegroundBlur = false
        this.deleteConfig()
      },
      confirm: ()=> {
        this.isEnableIndexForegroundBlur = false
        this.promptAction.showToast({ message: $r('app.string.click_error_prompt') })
      }
    }),
    cancel: () => {
      this.isEnableIndexForegroundBlur = false
    },
    autoCancel: true,
    alignment: DialogAlignment.Center,
    width: 328,
    backgroundColor: $r('app.color.list_item_background_color'),
  })

  /* Stackå±‚å å¸ƒå±€ */
  // æ‰€æœ‰å­ç»„ä»¶åœ¨å®¹å™¨å†…çš„å¯¹é½æ–¹å¼ TODO ã€ç”¨æˆ·é¦–é€‰é¡¹ã€‘åœ¨è®¾ç½®é‡Œå¯ä»¥æ›´æ”¹ Alignment.BottomStart å’Œ Alignment.BottomEnd Enlin@2024-12-04

  /* é…ç½®æ·»åŠ æŒ‰é’®bindSheetç›¸å…³ */

  // æ˜¯å¦æ˜¾ç¤ºbindSheet
  @Provide
  private isShowConfigAddBindSheet: boolean = false
  // æ˜¯å¦éœ€è¦å¾€`bindSheet`é‡Œ`push`è·¯ç”±é¡µé¢
  private isPushRoute2BindSheet: boolean = false
  // å†…å®¹Builder
  @Builder
  private ConfigAddBindSheetBuilder(){
    ConfigAdd()
  }

  /* é¡µé¢å¸ƒå±€ç›¸å…³ */
  // é…ç½®æ·»åŠ æŒ‰é’®å®½åº¦
  private proxyStartButtonWidth: Length = $r('app.integer.vp_proxy_not_start_button_width')
  // é…ç½®æ·»åŠ æŒ‰é’®é«˜åº¦
  private proxyStartButtonHeight: Length = $r('app.integer.vp_proxy_not_start_button_height')
  // é…ç½®æ·»åŠ æŒ‰é’®å‰SymbolåŠ¨æ•ˆ
  private ReplaceSymbolEffect: SymbolEffect = EffectScope.WHOLE

  async loadConfig(item: ConfigData, needUpdated = false){
    if (this.isLoading)
      return
    this.isLoading = true;
    this.currentConfigRadioCheckedConfigData = item
    this.appConfig.currentProfileName = item.configName
    this.appConfig.currentProfileId = item.configId
    try {
      if(needUpdated){
        ClashViewModel.updateProfileConfig(item.configId)
      }
      ClashViewModel.socketProxy.reset()
      await ClashViewModel.loadConfig(false)
    }catch (e) {
      console.debug("loadConfigList", e.message, JSON.stringify(e))
      promptAction.showToast({message: "åŠ è½½é…ç½®å¤±è´¥: " + (e.message || e) })
    }
    this.isLoading = false;
  }

  build() {
    Stack() {
      // æ ‡é¢˜æ  START
      //  if (!this.isLandscapePhone) {
      Row() {
        Text($r('app.string.Configuration'))
          .fontSize(this.curYOffset<0?TAB_CONTENT_TITLE_FONT_SIZE-this.curYOffset/100:TAB_CONTENT_TITLE_FONT_SIZE)
          .fontWeight(TAB_CONTENT_TITLE_FONT_WEIGHT)
          .fontColor($r('sys.color.font_primary'))
          .transition(customAnimationUtil.isSlide(200,this.uiConfig))
        Blank()
        // åˆ·æ–°å›¾æ ‡
        Button({ type: ButtonType.Circle, stateEffect: true }) {
          SymbolGlyph($r('sys.symbol.arrow_clockwise'))
            .fontSize(TAB_CONTENT_TITLE_SYMBOL_FONT_SIZE)
            .fontColor([$r('sys.color.icon_primary')])
            .effectStrategy(customAnimationUtil.isIconEffect(this.uiConfig))
        }
        .width(40)
        .height(40)
        .backgroundColor($r('app.color.settings_container_background'))
        .clickEffect(customAnimationUtil.isClickEffect(this.uiConfig))
        .onClick(() => {
          // TODO å›½é™…åŒ–é€‚é… æ›´æ–°é…ç½®ä¸­... æ›´æ–°é…ç½®æˆåŠŸã€
          this.isON.toggleAnim=true
          hilog.info(0xC001, this.componentName, `#button#onClick()#æ›´æ–°é…ç½®`)
          this.updateConfig()
        })
        .transition(customAnimationUtil.isSlide(0,this.uiConfig))
      }
      .zIndex(1)
      .height(this.curYOffset<0?TAB_CONTENT_TITLE_HEIGHT-this.curYOffset:TAB_CONTENT_TITLE_HEIGHT)
      .position({x:0})
      .alignItems(VerticalAlign.Center)
      .width('100%')
      .padding({
        left: this.breakPointStateTabContentTitleMargin.value,
        right: this.breakPointStateTabContentTitleMargin.value,
      })
      // .margin({ bottom: 15 })
      // }
      // æ ‡é¢˜æ  END

      // ä¸»ä½“ START
      Stack({ alignContent: this.stackAlignContentAlignment }) {
        if (this.configList.length === 0) {
          Nothing({ name: $r('app.string.Configuration') })
            .height('90%')
        } else {
          Column(){
            Blank().height(TAB_CONTENT_TITLE_HEIGHT)
            Scroll() {
              // é…ç½®åˆ—è¡¨ START
              List({ space: LIST_SPACE }) {
                ForEach(this.configList, (item: ConfigData,index: number) => {
                  ListItem() {
                    Row() {
                      Column({ space: 2 }) {
                        Text(item.configName).fontColor(($r('sys.color.font_primary'))).maxLines(1).textOverflow({ overflow: TextOverflow.Ellipsis })
                        Row() {
                          Text($r('app.string.update_by'))
                            .fontColor($r('sys.color.font_secondary')).fontSize(14)
                          Text(convertTime(item.lastUpdateDateTime))
                            .fontColor($r('sys.color.font_secondary')).fontSize(14).maxLines(1).textOverflow({ overflow: TextOverflow.Ellipsis })
                        }

                        // è¿›åº¦æ¡ç»„ä»¶: å…±ç”¨ä½¿ç”¨æµé‡ / æ€»æµé‡
                        if (item.subscriptionInfo){
                          cellularData(item.subscriptionInfo)
                        }

                      }.alignItems(HorizontalAlign.Start).width('85%').padding({top:10,bottom:10})

                      Blank()
                      if (item.configId === this.appConfig.currentProfileId && this.isLoading){
                        LoadingProgress()
                          .color(this.icon_emphasize)
                          .width(25).height(25)
                      }
                      Radio({ value: 'radio' + index, group: 'configGroup'})
                        .checked(item.configId === this.appConfig.currentProfileId)
                        .radioStyle({
                          checkedBackgroundColor: this.icon_emphasize,
                        })
                        .hitTestBehavior(HitTestMode.None)
                        .onClick(async () => {
                          this.isON.toggleAnim=true
                          await this.loadConfig(item)
                          hilog.info(0xC002, this.componentName,
                            `#ListItem#onClick:configName is [${this.currentConfigRadioCheckedConfigData.configName}]`)
                        })

                    }
                    .width('100%')
                    .padding(LIST_ITEM_PADDING)
                    .alignItems(VerticalAlign.Center)
                  }.width('100%')
                  .backgroundColor($r('app.color.container_background'))
                  .clickEffect(customAnimationUtil.isClickEffect(this.uiConfig))
                  .borderRadius(BORDER_RADIUS_20)
                  .hoverEffect(HoverEffect.Scale)
                  .transition(this.isON.toggleAnim ? null : customAnimationUtil.isScaleTran(index, this.uiConfig))
                  .bindContextMenu(this.configListLongPressCtxMenuBuilder(item?.isFavorite ?? false),
                    ResponseType.LongPress | ResponseType.RightClick,
                    {
                      preview: MenuPreviewMode.IMAGE,
                      previewAnimationOptions: { scale: [1.0, 1.1] },
                      placement: Placement.BottomRight,
                      aboutToAppear: () => {
                        if (this.uiConfig.isVibrate) {
                          customVibrator.vibratorTriggerOfHapticClockTimer()
                        }
                      }
                    })
                  .onClick(async () => {
                    this.isON.toggleAnim = true
                    await this.loadConfig(item)

                    hilog.info(0xC002, this.componentName, `#ListItem#onClick:configName is [${this.currentConfigRadioCheckedConfigData.configName}]`)
                  })
                  .onTouch((event: TouchEvent) => {
                    if (event.type === TouchType.Down) {
                      // TODO ç°åœ¨ç”¨æ¥ä»£æ›¿è·å–é•¿æŒ‰çš„æ˜¯å“ªä¸€ä¸ªListItemï¼Œç›®å‰ç”¨`configName`ä½œä¸ºæ¯ä¸€ä¸ªitemçš„å”¯ä¸€æ€§å±æ€§
                      this.currentTouchConfigData = item
                      hilog.info(0xC002, this.componentName,
                        `#ListItem#onTouch(TouchType.Down): configName is [${this.currentTouchConfigData.configName}]`)
                    }
                  })
                  .bindPopup(!!this.uiConfig.ShowConfigPop, {
                    builder: PopupBuilder(this, PopTips[1], () => {
                      this.uiConfig.ShowConfigPop = false
                    }),
                    onWillDismiss: false,
                    autoCancel: false
                  })

                })
              }
              .width('100%')
              .height('100%')
              .padding({
                left: this.breakPointStateTabContentTitleMargin.value,
                right: this.breakPointStateTabContentTitleMargin.value,
              })
              // 110 = app.integer.vp_proxy_start_button_margin *2 + app.integer.vp_proxy_not_start_button_width
              .contentEndOffset(CONTENT_END_OFFSET_150)
              .lanes(this.breakPointStateListLanes.value, this.breakPointStateListGutter.value)
              .edgeEffect(EdgeEffect.Spring)
              .chainAnimation(true)
              .nestedScroll({
                scrollForward: NestedScrollMode.PARENT_FIRST,
                scrollBackward: NestedScrollMode.SELF_FIRST
              })
              // é…ç½®åˆ—è¡¨ END
            }
            .edgeEffect(this.uiConfig.isAnimation?EdgeEffect.Spring:null)//,{alwaysEnabled:true})
            .onDidScroll((xOffset: number, yOffset: number, scrollState: ScrollState): void => {
              // ç´¯è®¡è®¡ç®—å½“å‰çˆ¶ç»„ä»¶æ»šåŠ¨åœ¨Yè½´æ–¹å‘çš„åç§»é‡
              if (this.uiConfig.isAnimation){
                this.curYOffset += yOffset
              }
              console.info("yOffset" + this.curYOffset);
            })
          }
        }

        // æ‚¬æµ®æ–°å¢é…ç½®æŒ‰é’® START
        Column() {
          RightDownButton(
            $r('sys.symbol.plus'),
            this.ReplaceSymbolEffect,
          )
        }
        .backgroundColor(this.icon_emphasize)
        .shadow({
          radius: 10,
          color: this.icon_emphasize,
          offsetY: 4,
          type: ShadowType.BLUR
        })
        .borderRadius(100)
        .width(this.proxyStartButtonWidth)
        .height(this.proxyStartButtonHeight)
        .clip(true)
        .hoverEffect(HoverEffect.Scale)
        .clickEffect(customAnimationUtil.isClickEffect(this.uiConfig))
        .transition(customAnimationUtil.isSlideSwitch(this.uiConfig))
        .margin({bottom:this.isLandscapePhone || !this.uiConfig.isBlurr ? $r('app.integer.vp_proxy_start_button_left_right_margin') : $r('app.integer.vp_proxy_start_button_bottom_margin'),right:$r('app.integer.vp_proxy_start_button_left_right_margin'),left:$r('app.integer.vp_proxy_start_button_left_right_margin')})
        .bindSheet( this.isShowConfigAddBindSheet, this.ConfigAddBindSheetBuilder, {
          detents: [BIND_SHEET_CONTAINER_HEIGHT, SheetSize.LARGE, ],// SheetSize.LARGE
          backgroundColor: $r('app.color.background'),
          showClose: true,
          dragBar: false,
          preferType: SheetType.CENTER,
          scrollSizeMode: ScrollSizeMode.CONTINUOUS,
          // width: ('100%'),
          /**
           * åŠæ¨¡æ€é¡µé¢æ˜¾ç¤ºï¼ˆåŠ¨ç”»å¼€å§‹å‰ï¼‰å›è°ƒå‡½æ•°
           *    ç›®å‰`é€šè¿‡URL(é“¾æ¥)å¯¼å…¥`å’Œ`é•¿æŒ‰é…ç½®ç¼–è¾‘`æ˜¯ç”¨çš„åŒä¸€ä¸ªé¡µé¢ï¼Œ
           *    è¿™é‡Œä¸»è¦æ˜¯ç”¨æ¥å¤„ç†æ‹‰èµ·`bindSheet`ä¹‹åå¯ä»¥ç­‰`bindSheet`æ¸²æŸ“å®Œæ¯•ä¹‹åæ­£ç¡®ä¼ å…¥è·¯ç”±ä¿¡æ¯
           */
          onWillAppear: () => {
            hilog.info(0xC020, this.componentName, `#button#bindSheet#onWillAppear() executed`)
            if (this.isPushRoute2BindSheet) {
              this.pushEditConfigRoute2BindSheet()
              this.isPushRoute2BindSheet = false
            }
          },
          // åŠæ¨¡æ€é¡µé¢äº¤äº’å¼å…³é—­å›è°ƒå‡½æ•°
          onWillDismiss: (dismissSheet :DismissSheetAction) => {
            // åœ¨äºŒçº§è·¯ç”±é¡µé¢å†…åªèƒ½é€šè¿‡ç‚¹å‡»å…³é—­æŒ‰é’®æ‰èƒ½å…³æ‰bindSheet
            if (this.configAddPageInfos.size() <= 0 || (dismissSheet.reason === DismissReason.CLOSE_BUTTON)) {
              dismissSheet.dismiss()
              this.isShowConfigAddBindSheet = false
              this.isEnableIndexForegroundBlur = false
              this.configAddPageInfos.clear(true)
              hilog.info(0xC020, this.componentName, `#button#bindSheet#onWillDismiss()#å…³é—­é…ç½®æ·»åŠ æŒ‰é’®çš„bindSheetï¼šDismissSheetAction.dismiss()`)
            }
          },
          onWillSpringBackWhenDismiss: (springBack: SpringBackAction)=> {
            springBack.springBack()
          }
        })
        .onClick( () => {
          this.isShowConfigAddBindSheet = true
          this.isEnableIndexForegroundBlur = true
          if (this.uiConfig.isVibrate) {
            customVibrator.vibratorTriggerOfHapticClockTimer()
          }
        })
        // æ‚¬æµ®æ–°å¢é…ç½®æŒ‰é’® END
      }
      .backgroundColor($r('app.color.background'))
      .width('100%')
      .height('100%')
      // ä¸»ä½“ END
    }
    .width('100%')
    .height('100%')
    .animation({ duration: this.uiConfig.animationSpeed, curve: Curve.Linear, delay: 0 })
  }

  @StorageLink('appConfig') appConfig: AppConfig = new AppConfig()
  @StorageLink('favoriteProfiles') favoriteProfiles: Map<string, string> = new Map<string, string>([])

  aboutToAppear(): void {
    hilog.info(0xC000, this.componentName, `#aboutToAppear executed`)
    // XXX åˆ é™¤ è¿™é‡Œæ¨¡æ‹Ÿè·å–æ‰€æœ‰hapæ²™ç®±è·¯å¾„é…ç½®æ–‡ä»¶çš„æ–‡ä»¶å
    showFileNameListOfFileDir(this.context.filesDir)
    EventHub.on(EventKey.FetchProfile, () => {
      this.fetchProfiles()
    })


  }
  // è·å–é…ç½®åˆ—è¡¨
  async fetchProfiles(){
    const profiles = await ClashViewModel.getProfiles()
    this.configList = profiles.map((d)=>{
      return {
        configId: d.id,
        configName: d.name,
        isFavorite: this.favoriteProfiles.has(d.id) ?? false,
        configUrl: d.url,
        isConfigAutoUpdate: d.autoUpdate,
        configAutoUpdateTimeGapValue: d.autoUpdateDuration,
        lastUpdateDateTime: d.lastUpdateDate,
        subscriptionInfo: d.subscriptionInfo
      } as ConfigData
    })
  }

  aboutToDisappear(): void {
    hilog.info(0xC000, this.componentName, `#aboutToDisappear executed`)
    EventHub.off(EventKey.FetchProfile)
    this.configCustomDialogController = null
    this.isEnableIndexForegroundBlur = false
    hilog.info(0xC000, this.componentName, `#aboutToDisappear#ç½®ç©º[é…ç½®é¡µ\`bindSheet\`å†…æç¤ºæ˜¯å¦åˆ é™¤é…ç½®ä¿¡æ¯çš„è‡ªå®šä¹‰å¼¹æ¡†]`)
  }

  /**
   * é¡µé¢å†…é€šç”¨ `é…ç½®NVè·¯ç”±` pushæ–¹æ³•
   * @param routeName å°†è¦è·¯ç”±çš„é¡µé¢åç§°
   * @param param     è·¯ç”±å‚æ•°
   * @param animated  æ˜¯å¦å¯ç”¨è½¬åœºåŠ¨ç”»
   */
  pushDestinationByName(routeName: RouteName, param: Object | null, animated?: boolean): void {
    this.configAddPageInfos.pushDestinationByName(routeName, param, animated)
    hilog.info(0xC000, this.componentName, `#pushDestinationByName#NavPathStack.pushDestinationByName(${routeName}, ${JSON.stringify(param)}, ${animated})`)

  }

  /**
   * æ‹‰èµ·é…ç½®ç¼–è¾‘é¡µ å¹¶ä¼ å‚
   */
  private pushEditConfigRoute2BindSheet(){
    this.pushDestinationByName(RouteName.IMPORT_CONFIG_FROM_URL, this.currentTouchConfigData)
  }

  /**
   * æ”¶è—é…ç½®
   */
  private favoriteConfig(): void {
    // TODO æ”¶è—é…ç½® & åˆ¤æ–­æ˜¯å¦å·²ç»æ”¶è—
    if (this.favoriteProfiles.size<=3){
    this.promptAction.showToast({ message: $r('app.string.Collect_Tip') })
    hilog.info(0xC010, this.componentName, `#favoriteConfig#æ”¶è—é…ç½®: configName is [${this.currentTouchConfigData.configName}]`)
    this.currentTouchConfigData.isFavorite = true
    this.favoriteProfiles.set(this.currentTouchConfigData.configId, this.currentTouchConfigData.configName)
    }else {
      this.promptAction.showToast({ message: $r('app.string.favorite_config_no') })
    }
  }
  /**
   * å–æ¶ˆæ”¶è—é…ç½®
   */
  private cancelFavoriteConfig(): void {
    // TODO å–æ¶ˆæ”¶è—é…ç½® & åˆ¤æ–­æ˜¯å¦å·²ç»æ”¶è—
    this.promptAction.showToast({ message: $r('app.string.uncollected_tip') })
    hilog.info(0xC010, this.componentName, `#favoriteConfig#å–æ¶ˆæ”¶è—é…ç½®: configName is [${this.currentTouchConfigData.configName}]`)
    this.currentTouchConfigData.isFavorite = false
    this.favoriteProfiles.delete(this.currentTouchConfigData.configId)
  }
  /**
   * ç¼–è¾‘é…ç½®
   */
  private editConfig(): void {
    // TODO ç¼–è¾‘bindSheet
    hilog.info(0xC011, this.componentName, `#editConfig#ç¼–è¾‘é…ç½®: configName is [${this.currentTouchConfigData.configName}]`)
    this.isShowConfigAddBindSheet = true
    this.isPushRoute2BindSheet = true
  }
  /**
   * æ›´æ–°é…ç½®
   */
  private async updateConfig(configId?: string): Promise<void> {
    // TODO è°ƒç”¨æ›´æ–°é…ç½®æ¶ˆæ¯api
    this.promptAction.showToast({message: `é…ç½®æ›´æ–°ä¸­...`})
    if (configId){
      //ä½¿å¼€å…³ç‚¹å‡»æ—¶ä¸è§¦å‘è½¬åœºåŠ¨ç”»
      this.isON.toggleAnim = true

      this.loadConfig(this.currentTouchConfigData, true)
      //ä½¿å¼€å…³ç‚¹å‡»æ—¶ä¸è§¦å‘è½¬åœºåŠ¨ç”»
      this.isON.toggleAnim = true
      // TODO å•ä¸ªé…ç½®æ›´æ–°
      hilog.info(0xC012, this.componentName, `#updateConfig#æ›´æ–°é…ç½®{å•ä¸ª}: configName is [${this.currentTouchConfigData.configName}], configId is [${this.currentTouchConfigData.configId}]`)
    } else {
      //ä½¿å¼€å…³ç‚¹å‡»æ—¶ä¸è§¦å‘è½¬åœºåŠ¨ç”»
      this.isON.toggleAnim = true
      // TODO æ‰€æœ‰é…ç½®æ›´æ–°
      hilog.info(0xC012, this.componentName, `#updateConfig#æ›´æ–°é…ç½®{æ‰€æœ‰}`)
      // TODO loading and try
      await ClashViewModel.updateProfileConfig(null)
    }


  }
  /**
   * åˆ†äº«é…ç½®çš„URL
   */
  private shareConfigUrl(): void {
    // TODO å¤„ç†å¾…åˆ†äº«æ•°æ® å¹¶è°ƒç”¨ç³»ç»Ÿåˆ†äº«æ¥å£ åªæœ‰URLå¯¼å…¥çš„é…ç½®æ‰å¯ä»¥åˆ†äº«é“¾æ¥
    hilog.info(0xC013, this.componentName, `#shareConfig#åˆ†äº«é…ç½®: configName is [${this.currentTouchConfigData.configName}]`)
    let systemShareResult: boolean = configShare(this.context, this.currentTouchConfigData.configUrl, this.currentTouchConfigData.configId)
    if (!systemShareResult) {
      this.promptAction.showToast({ message: `åˆ†äº«é”™è¯¯ï¼Œè¯·è”ç³»å¼€å‘è€…ï¼ğŸ›` })
    }
  }
  /**
   * ç”Ÿæˆé…ç½®çš„URLè½¬æˆçš„äºŒç»´ç 
   *    1. URL & äºŒç»´ç  å¯¼å…¥çš„é…ç½®ç”¨å¯¹åº”URLç”ŸæˆäºŒç»´ç 
   *    2. å…¶ä»–æ–¹å¼å¯¼å…¥çš„é…ç½®ä¸èƒ½ç”ŸæˆäºŒç»´ç 
   */
  private generateQRcode(): void {
    // TODO å¼¹æ¡†CustomDialogï¼Œåœ¨å…¶ä¸­å®ç°â€œé…ç½®urlâ€ç”ŸæˆäºŒç»´ç çš„åŠŸèƒ½
    if (this.currentTouchConfigData.sourceType !== ConfigDataSourceType.URL &&
      this.currentTouchConfigData.sourceType !== ConfigDataSourceType.QR_CODE ) {
      this.promptAction.showToast({ message: `${getResourceString($r('app.string.config_share_prompt'), this)}~ğŸ«¡` })
    }
    hilog.info(0xC014, this.componentName, `#generateQRcode#ç”ŸæˆäºŒç»´ç : configName is [${this.currentTouchConfigData.configName}]`)
  }
  /**
   * å¯¼å‡ºé…ç½®
   */
  private exportConfig(): void {
    // TODO åˆ é™¤ç”¨æˆ·é¦–é€‰é¡¹é‡Œçš„æ­¤é…ç½®
    hilog.info(0xC015, this.componentName, `#deleteConfig#åˆ é™¤é…ç½®: configName is [${this.currentTouchConfigData.configName}]`)
  }
  /**
   * åˆ é™¤é…ç½®
   */
  private async  deleteConfig(): Promise<void> {
    // TODO åˆ é™¤ç”¨æˆ·é¦–é€‰é¡¹é‡Œçš„æ­¤é…ç½®
    this.promptAction.showToast({ message: `${getResourceString($r('app.string.configuration_deleted'), this)}ğŸ’”` })
    hilog.info(0xC016, this.componentName, `#deleteConfig#åˆ é™¤é…ç½®: configName is [${this.currentTouchConfigData.configName}]`)
    await ClashViewModel.deleteProfile(this.currentTouchConfigData.configId)
    this.fetchProfiles()
  }
}


export default ConfigurationPage