//ä¸»é¡µ æ …æ ¼å¸ƒå±€ã€åª’ä½“æŸ¥è¯¢
import { BreakpointState } from '../common/breakpointsystem'
import { componentSnapshot, PromptAction, window } from '@kit.ArkUI'
import SwitchMode from '../components/Home/SwitchMode'
import CellularData from '../components/Home/CellularData'
import PublicNetwork from '../components/Home/PublicNetwork'
import Speed from '../components/Home/Speed'
import { getGreeting } from '../utils/GreetingUtil'
import { hilog } from '@kit.PerformanceAnalysisKit'
import { Timer } from '../common/HHmmssTimer'
import {
  PROXY_STARTED_DURATION_INIT_VALUE,
  ANIMATION_DURATION_300,
  TAB_CONTENT_TITLE_SYMBOL_FONT_SIZE,
  BIND_SHEET_CONTAINER_HEIGHT,
  TAB_CONTENT_TITLE_HEIGHT,
  gutterHomeGridcol,
  MarginGenerate,
} from '../common/Constants'
import Settings from '../components/Settings/Settings'
import CurrentNode from '../components/Home/CurrentNode'
import FavoriteProxy from '../components/Home/FavoriteProxy'
import FavoriteConfiguration from '../components/Home/FavoriteConfiguration'
import { CardEdit } from '../components/Home/CardEdit'
import { image } from '@kit.ImageKit'
import ProxyINFO from '../components/Home/ProxyINFO'
import CurrentConfiguration from '../components/Home/CurrentConfiguration'
import ClashViewModel from '../entryability/ClashViewModel'
import Shortcuts from '../components/Home/Shortcuts'
import { display } from '@kit.ArkUI';


@Entry
@Component
struct Home {

  /* ä¸»é¢˜è‰² */
  @Consume('icon_emphasize')
  icon_emphasize: ResourceColor

  // è®¾ç½®æ¨¡æ€é¡µæ§åˆ¶å˜é‡
  @State isShowSettings: boolean = false
  // è®¾ç½®æŒ‰é’®å¯¼èˆª
  @Provide('NavSettingsPathStack') SettingsPageInfos: NavPathStack = new NavPathStack()
  // è®¾ç½® -> å¤‡ä»½ä¸æ¢å¤ -> æ˜¯å¦å¯ç”¨äº‘å¤‡ä»½é…ç½®
  @Provide isShowCloudconfig: boolean = false
  // è®¾ç½®é¡µè¯­è¨€é€‰ä¸­æš‚å­˜å˜é‡
  @Provide currentLanguage: ResourceStr = $r('app.string.Language_Subtitle')
  // è®¾ç½® -> é€šçŸ¥ -> æµé‡æé†’å¯ç”¨çŠ¶æ€å˜é‡
  @Provide EnableCellularDataReminder: boolean = false
  // è®¾ç½®é¡µå®éªŒåŠŸèƒ½æç¤ºæ¡†æ˜¾ç¤ºå˜é‡
  @Provide isShowExperimentalFunction: boolean = true
  // è®¾ç½® -> åå°è¿è¡Œ -> æµé‡æé†’å¯ç”¨çŠ¶æ€å˜é‡
  @Provide Enablebackgrounder: boolean = false
  // æ‰€æœ‰å­ç»„ä»¶åœ¨å®¹å™¨å†…çš„å¯¹é½æ–¹å¼
  @Consume ('stackAlignContentAlignment') stackAlignContentAlignment: Alignment
  //ä¸€çº§å›¾æ ‡è‰²ï¼Œé»‘è‰²
  @State icon_primary: ResourceColor = $r('sys.color.icon_primary')
  //äºŒçº§å›¾æ ‡è‰²ï¼Œç°è‰²
  @State icon_secondary: ResourceColor = $r('sys.color.icon_secondary')
  //ä¸€çº§æ–‡æœ¬è‰²ï¼Œé»‘è‰²
  @State font_primary: ResourceColor = $r('sys.color.font_primary')
  //ç³»ç»Ÿé¢œè‰²è°ƒç”¨
  @State currentBp: string = ''
  // é»˜è®¤é—®å€™è¯­
  @State greetings: Resource = $r('app.string.GoodMorning')
  @State ContainerHeight: string = ''
  @State TopHeight: string = ''
  /* ä¸»é¡µå¡ç‰‡é«˜åº¦*/
  @Consume('HomeCardEditHeight') private HomeCardEditHeight: BreakpointState<number>

  windowClass = AppStorage.get<window.Window>('windowClass') as window.Window;
  //ç¼–è¾‘æŒ‰é’®ç‚¹å‡»åæ˜¾ç¤ºç¼–è¾‘çŠ¶æ€åˆ¤å®š
  @Provide isShowHomeEdit: boolean = false
  /*
  ä¸»é¡µå¡ç‰‡ç»„ä»¶æˆªå›¾
 */
  @Consume ('pixmapSpeed')pixmapSpeed: image.PixelMap | undefined
  @Consume ('pixmapSwitchMode')pixmapSwitchMode: image.PixelMap | undefined
  @Consume ('pixmapCellularData')pixmapCellularData: image.PixelMap | undefined
  @Consume ('pixmapCurrentNode')pixmapCurrentNode: image.PixelMap | undefined
  @Consume ('pixmapPublicNetwork')pixmapPublicNetwork: image.PixelMap | undefined
  @Consume ('pixmapFavoriteProxy')pixmapFavoriteProxy: image.PixelMap | undefined
  @Consume ('pixmapFavoriteConfiguration')pixmapFavoriteConfiguration: image.PixelMap | undefined
  @Consume ('pixmapCurrentConfiguration')pixmapCurrentConfiguration: image.PixelMap | undefined
  @Consume ('pixmapProxyINFO')pixmapProxyINFO: image.PixelMap | undefined
  @Consume ('pixmapShortcuts')pixmapShortcuts: image.PixelMap | undefined
  /**
   * æ˜¯å¦ä¿å­˜å¸ƒå±€å¼¹çª—
   */
  SaveDialogController: CustomDialogController | null = new CustomDialogController({
    builder: SaveCustomDialog({
      cancel: () => {
        this.onCancel()
      },
      confirm: () => {
        this.onAccept()
      }
    }),
    cancel: this.existApp,
    autoCancel: true,
    alignment: DialogAlignment.Center,
    customStyle: false,
    cornerRadius: 32,
  })

  /*
  ç¼–è¾‘æ¨¡å¼ä¸‹å³ä¸Šè§’åˆ é™¤æŒ‰é’®
   */
  @Consume deleteButtonSize: BreakpointState<number>
  //åˆ é™¤æŒ‰é’®æ˜¯å¦å‡ºç°åˆ¤å®š
  @State isShowDeleteButton: boolean = false
  //å¡ç‰‡ç¼–è¾‘åŠæ¨¡æ‹Ÿæ€åˆ¤å®š
  @State isShowCardEdit: boolean = false
  /* å¡ç‰‡å¸è½½æ·»åŠ åˆ¤å®šåŠå¡ç‰‡ */
  @Provide('isShowSpeed') isShowSpeed: boolean = true
  @Provide('isShowSwitchMode') isShowSwitchMode: boolean = true
  @Provide('isShowCellularData') isShowCellularData: boolean = true
  @Provide('isShowCurrentNode') isShowCurrentNode: boolean = true
  @Provide('isShowPublicNetwork') isShowPublicNetwork: boolean = true
  @Provide('isShowFavoriteProxy') isShowFavoriteProxy: boolean = true
  @Provide('isShowFavoriteConfiguration') isShowFavoriteConfiguration: boolean = true
  @Provide('isShowProxyINFO') isShowProxyINFO: boolean = false
  @Provide('isShowCurrentConfiguration') isShowCurrentConfiguration: boolean = false
  @Provide('isShowShortcuts') isShowShortcuts: boolean = false
  // é¡µé¢åç§° ä¸»é¡µ
  private componentName: string = 'HomePage'
  /* æ˜¯å¦å¼€å¯ `Index` é¡µé¢çš„å‰æ™¯æ¨¡ç³Š */
  @Consume('isEnableIndexForegroundBlur') private isEnableIndexForegroundBlur: boolean
  /* æ˜¯å¦å¼€å¯å…¨å±€åŠ¨ç”»åˆ¤å®š */
  @Consume ('isAnimation') isAnimation: boolean
  /* Stackå±‚å å¸ƒå±€ */
  /* ä»£ç†å¯åŠ¨æŒ‰é’® */
  private promptAction: PromptAction = this.getUIContext()?.getPromptAction()
  // ä»£ç†å¯åŠ¨æŒ‰é’®çŠ¶æ€
  @State private proxyEnabled: boolean = false
  // ä»£ç†å¯åŠ¨æŒç»­çš„æ—¶é—´
  @State private proxyStartingDuration: string = PROXY_STARTED_DURATION_INIT_VALUE
  // æŒ‰é’®å®½åº¦
  @State private proxyStartButtonWidth: Length = $r('app.integer.vp_proxy_not_start_button_width')
  // æŒ‰é’®é«˜åº¦
  @State
  private proxyStartButtonHeight: Length = $r('app.integer.vp_proxy_not_start_button_height')
  // æŒ‰é’®å‰SymbolåŠ¨æ•ˆ
  private ReplaceSymbolEffect: SymbolEffect = EffectScope.WHOLE // æŒ‰é’®å‰SymbolåŠ¨æ•ˆ
  // å®šæ—¶å™¨Controller
  private proxyStartedTimer: Timer = new Timer()
  /* å½“å‰è®¾å¤‡`height`æ˜¯å¦ç¬¦åˆ(320vp< height <= 500vp) */
  @StorageProp('isLandscapePhone') private isLandscapePhone: boolean = false
  // ä¸»é¡µå¡ç‰‡å†…è¾¹è·
  @Consume('breakPointStateHomeCardPadding') private cardPadding: BreakpointState<MarginGenerate>
  // ä¸»é¡µå¡ç‰‡å†…è¾¹è·
  @Consume('gutterHomeGridcol_12_15') private gutterHomeGridcol: BreakpointState<gutterHomeGridcol>
  //ä¸»é¡µæ•´ä¸ªå¡ç‰‡åŒºåŸŸè¾¹è·
  @Consume('HomeCardAreaPadding') private HomeCardAreaPadding: BreakpointState<MarginGenerate>
  @Consume('breakPointStateTabContentTitleMargin') private breakPointStateTabContentTitleMargin: BreakpointState<number>
  /**ä¸»é¡µå¡ç‰‡æ ‡é¢˜æŒ‰é’®é—´è·*/
  @Consume('HomeCardTitleButtonPadding') private HomeCardTitleButtonPadding: BreakpointState<number>
  // æŠ˜å å±å±•å¼€çŠ¶æ€åˆ¤å®š
  @StorageProp('isFoldStatus') private isFoldStatus: boolean = false

  aboutToAppear() {
    this.greetings = getGreeting()
    console.log('é—®å€™è¯­:' + this.greetings)
  }

  aboutToDisappear() {
    this.SaveDialogController = null // å°†dialogControllerç½®ç©º
  }

  // åœ¨è‡ªå®šä¹‰ç»„ä»¶å³å°†ææ„é”€æ¯æ—¶å°†dialogControllerç½®ç©º
  onCancel() {
    this.restoreLayout()
    this.isEnableIndexForegroundBlur=false
    hilog.info(0xA000, this.componentName, '#onCancel: Callback when the first button is clicked')
  }

  onAccept() {
    this.saveHomeLayout()
    this.isEnableIndexForegroundBlur=false
    hilog.info(0xA000, this.componentName, '#onAccept: Callback when the second button is clicked')
  }

  existApp() {
    this.isEnableIndexForegroundBlur=false
    hilog.info(0xA000, this.componentName, '#existApp: Click the callback in the blank area')
  }

  /**
   * è¿˜åŸä¸»é¡µå¡ç‰‡å¸ƒå±€
   */
  restoreLayout() {
    // TODO å›½é™…åŒ–
    this.promptAction.showToast({ message: `å¸ƒå±€å·²è¿˜åŸğŸ«¡` })
    this.isShowHomeEdit = false
      animateTo({ duration: ANIMATION_DURATION_300, curve: Curve.Linear }, () => {
        this.isShowDeleteButton = false
      })
    this.isShowSpeed = true
    this.isShowSwitchMode = true
    this.isShowCellularData = true
    this.isShowCurrentNode = true
    this.isShowPublicNetwork = true
    this.isShowFavoriteProxy = true
    this.isShowFavoriteConfiguration = true
    this.isShowProxyINFO = false
    this.isShowCurrentConfiguration = false
    this.isShowShortcuts = false
  }

  /**
   * ä¿å­˜ä¸»é¡µå¡ç‰‡å¸ƒå±€
   */
  saveHomeLayout() {
    // TODO å›½é™…åŒ–
    this.promptAction.showToast({ message: `å¸ƒå±€å·²ä¿å­˜ğŸ’¾` })
    this.isShowHomeEdit = false
    if (this.isAnimation) {
      animateTo({ duration: ANIMATION_DURATION_300, curve: Curve.Linear }, () => {
        this.isShowDeleteButton = false
      })
    }else {this.isShowDeleteButton = false}
  }

  // é€šè¿‡@Builderæ„å»ºè®¾ç½®æ¨¡æ€å±•ç¤ºç•Œé¢
  @Builder
  SettingsSheet() {
    Column() {
      Settings()
    }
    .width('100%')
    .height('100%')
    //.backgroundColor(Color.White)
  }

  //å¡ç‰‡ç¼–è¾‘åŠæ¨¡æ‹Ÿæ€
  @Builder
  CardEdit() {
    CardEdit()
  }




  build() {
    Column() {
      if (!this.isLandscapePhone) {
        Row({space: this.HomeCardTitleButtonPadding.value}) {
          if (!this.isShowHomeEdit) {
            //ç¼–è¾‘å¸ƒå±€æŒ‰é’®åˆ¤å®šï¼šéç¼–è¾‘çŠ¶æ€
            Text(this.greetings)
              .fontSize(32)
              .fontWeight(FontWeight.Bold)
       //       .margin({ left: this.gridMargin })
              .fontColor(this.font_primary)
              .transition(this.isAnimation ?TransitionEffect.OPACITY.animation({ duration: ANIMATION_DURATION_300, delay: 0 })
                .combine(TransitionEffect.SLIDE):null)
            Blank()

            //ç¼–è¾‘æŒ‰é’®
            Button({ type: ButtonType.Circle, stateEffect: true }) {
              SymbolGlyph($r('sys.symbol.square_and_pencil'))
                .fontSize(TAB_CONTENT_TITLE_SYMBOL_FONT_SIZE)// .renderingStrategy(SymbolRenderingStrategy.MULTIPLE_COLOR)//åˆ†å±‚é¢œè‰²
                .fontColor([this.icon_primary])
            }
            .transition(this.isAnimation ?TransitionEffect.OPACITY.animation({ duration: ANIMATION_DURATION_300, delay: 0 })
              .combine(TransitionEffect.SLIDE):null)
            .onClick(() => {
              this.isShowHomeEdit = true
              if (this.isAnimation) {
                animateTo({ duration: ANIMATION_DURATION_300, curve: Curve.Linear }, () => {
                  this.isShowDeleteButton = true
                })
              }else {this.isShowDeleteButton = true}
            })
       //     .margin({ right: this.gridMargin })
            .width(40)
            .height(40)
            .backgroundColor($r('app.color.settings_container_background'))

            //è®¾ç½®æŒ‰é’®
            Button({ type: ButtonType.Circle, stateEffect: true }) {
              SymbolGlyph($r('sys.symbol.gearshape'))
                .fontSize(TAB_CONTENT_TITLE_SYMBOL_FONT_SIZE)
                .fontColor([this.icon_primary]) //è®¾ç½®å›¾æ ‡æ— æ³•åˆ†å±‚è®¾ä¸ºå•è‰²
            }
         //   .margin({ right: this.gridMargin })
            .width(40)
            .height(40)
            .backgroundColor($r('app.color.settings_container_background'))
            .transition(this.isAnimation ?TransitionEffect.OPACITY.animation({ duration: ANIMATION_DURATION_300, delay: 0 })
              .combine(TransitionEffect.SLIDE):null)
            .onClick(() => {
              this.isShowSettings = true
              this.isEnableIndexForegroundBlur = true
            })
          } else {
            //ç¼–è¾‘å¸ƒå±€æŒ‰é’®åˆ¤å®šï¼šæ˜¯ç¼–è¾‘çŠ¶æ€
            Text($r('app.string.home_edit'))
              .fontSize(32)
              .fontWeight(FontWeight.Bold)
         //     .margin({ left: this.gridMargin })
              .fontColor(this.font_primary)
              .transition(this.isAnimation ?TransitionEffect.OPACITY.animation({ duration: ANIMATION_DURATION_300, delay: 0 })
                .combine(TransitionEffect.SLIDE):null)
            Blank()
            //æ·»åŠ æŒ‰é’®
            Button({ type: ButtonType.Circle, stateEffect: true }) {
              SymbolGlyph($r('sys.symbol.plus'))
                .fontSize(TAB_CONTENT_TITLE_SYMBOL_FONT_SIZE)// .renderingStrategy(SymbolRenderingStrategy.MULTIPLE_COLOR)//åˆ†å±‚é¢œè‰²
                .fontColor([Color.White])
            }
         //   .margin({ right: this.gridMargin })
            .width(40)
            .height(40)
            .backgroundColor(this.icon_emphasize)
            .transition(this.isAnimation ?TransitionEffect.OPACITY.animation({ duration: ANIMATION_DURATION_300, delay: 0 })
              .combine(TransitionEffect.SLIDE):null)
            .onClick(() => {
              this.isShowCardEdit = true
              this.isEnableIndexForegroundBlur = true
            })

            //ä¿å­˜æŒ‰é’®
            Button({ type: ButtonType.Circle, stateEffect: true }) {
              SymbolGlyph($r('sys.symbol.save'))
                .fontSize(TAB_CONTENT_TITLE_SYMBOL_FONT_SIZE)
                .fontColor([Color.White])
            }
         //   .margin({ right: this.gridMargin })
            .width(40)
            .height(40)
            .backgroundColor(this.icon_emphasize)
            .transition(this.isAnimation ?TransitionEffect.OPACITY.animation({ duration: ANIMATION_DURATION_300, delay: 0 })
              .combine(TransitionEffect.SLIDE):null)
            .onClick(() => {
              this.saveHomeLayout()
            })

            //å–æ¶ˆæŒ‰é’®
            Button({ type: ButtonType.Circle, stateEffect: true }) {
              SymbolGlyph($r('sys.symbol.xmark'))
                .fontSize(TAB_CONTENT_TITLE_SYMBOL_FONT_SIZE)
                .fontColor([Color.White])
            }
         //   .margin({ right: this.gridMargin })
            .width(40)
            .height(40)
            .backgroundColor(this.icon_emphasize)
            .transition(this.isAnimation ?TransitionEffect.OPACITY.animation({ duration: ANIMATION_DURATION_300, delay: 0 })
              .combine(TransitionEffect.SLIDE):null)
            .onClick(() => {
              if (this.SaveDialogController != null) {
                this.SaveDialogController.open()
                this.isEnableIndexForegroundBlur = true
              }
            })
          }
        }
        .width('100%')
        .height(TAB_CONTENT_TITLE_HEIGHT)
        .geometryTransition("Button")
        .padding({
          left: this.breakPointStateTabContentTitleMargin.value,
          right: this.breakPointStateTabContentTitleMargin.value,
        })
        // transitionä¿è¯ç»„ä»¶ç¦»åœºä¸è¢«ç«‹å³ææ„ï¼Œå¯è®¾ç½®å…¶ä»–è½¬åœºæ•ˆæœ
        .transition(this.isAnimation ? TransitionEffect.OPACITY:null)
      }

Stack({ alignContent: this.stackAlignContentAlignment }) {
        // ä¸»é¡µå¡ç‰‡å±‚
    List() {
      ListItem() {
        GridRow({ gutter: this.isLandscapePhone ? { x: 12, y: 15 } : this.gutterHomeGridcol.value }) {
          //ç½‘ç»œé€Ÿåº¦å°å¡ç‰‡
          if (this.isShowSpeed) {
            GridCol({
              span: { xs: this.isLandscapePhone ? 6 : 12, md: this.isLandscapePhone ? 6 :this.isFoldStatus ? 8 : 12, lg: 6 },
              order: 1
            }) {
              Stack({ alignContent: Alignment.TopEnd }) {
                Speed()
                if (this.isShowDeleteButton) {
                  DeleteButton1()
                    .position({ x: '95%', y: -4 })
                    .onClick(() => {
                        animateTo({ duration: ANIMATION_DURATION_300, curve: Curve.Linear }, () => {
                          this.isShowSpeed = false
                        })
                    })
                }
              }
            }
            .aspectRatio(2.07)
            .borderRadius(20)
            .backgroundColor($r('app.color.container_background'))
            .clickEffect({ level: ClickEffectLevel.MIDDLE })
            .transition(this.isAnimation ? TransitionEffect.scale({x: 0, y: 0}).animation({ duration: ANIMATION_DURATION_300 }):null)
            .height(this.isLandscapePhone ? '160vp' : this.HomeCardEditHeight.value)
            //æ¶ˆå¤±è§¦å‘å›è°ƒ
            .onDetach(() => {
              //ç»„ä»¶æˆªå›¾åˆ°åŠæ¨¡æ‹Ÿæ€çš„æ·»åŠ å°å¡ç‰‡é‡Œï¼Œæ–¹ä¾¿æ“ä½œ
              componentSnapshot.get('SpeedId', (error: Error, pixmap: image.PixelMap) => {
                if (error) {
                  console.log("error: " + JSON.stringify(error))
                  return;
                }
                this.pixmapSpeed = pixmap //æˆªå›¾æ•ˆæœä¸ºåæ•ˆæœ
              })
            })
            .onAttach(() => {
            }) //æ˜¾ç¤ºæ—¶è§¦å‘å›è°ƒ
          }

          //åˆ†æµæ¨¡å¼å°å¡ç‰‡
          if (this.isShowSwitchMode) {
            GridCol({
              span: { xs: this.isLandscapePhone ? 3 : 6, md: this.isLandscapePhone ? 3 : this.isFoldStatus ? 4 : 6, lg: 3 },
              order: 2
            }) {
              Stack({ alignContent: Alignment.TopEnd }) {
                SwitchMode()
                if (this.isShowDeleteButton) {
                  DeleteButton2()
                    .position({ x: '90%', y: -4 })
                    .onClick(() => {
                        animateTo({ duration: ANIMATION_DURATION_300, curve: Curve.Linear }, () => {
                          this.isShowSwitchMode = false
                        })
                    })
                }
              }
            }
            // .margin({ right: this.containerMargin.value })
            .GridColStyle()
            .height(this.isLandscapePhone ? '160vp' : this.HomeCardEditHeight.value)
            .transition(this.isAnimation ? TransitionEffect.scale({x: 0, y: 0}).animation({ duration: ANIMATION_DURATION_300 }):null)
            //æ¶ˆå¤±è§¦å‘å›è°ƒ
            .onDetach(() => {
              //ç»„ä»¶æˆªå›¾åˆ°åŠæ¨¡æ‹Ÿæ€çš„æ·»åŠ å°å¡ç‰‡é‡Œï¼Œæ–¹ä¾¿æ“ä½œ
              componentSnapshot.get('SwitchModeId', (error: Error, pixmap: image.PixelMap) => {
                if (error) {
                  console.log("error: " + JSON.stringify(error))
                  return;
                }
                this.pixmapSwitchMode = pixmap //æˆªå›¾æ•ˆæœä¸ºåæ•ˆæœ
              })
            })
          }

          //æµé‡ç»Ÿè®¡å°å¡ç‰‡
          if (this.isShowCellularData) {
            GridCol({
              span: { xs: this.isLandscapePhone ? 3 : 6, md: this.isLandscapePhone ? 3 : this.isFoldStatus ? 4 : 6, lg: 3 },
              order: 3
            }) {
              Stack({ alignContent: Alignment.TopEnd }) {
                CellularData()
                if (this.isShowDeleteButton) {
                  DeleteButton2()
                    .position({ x: '90%', y: -4 })
                    .onClick(() => {
                        animateTo({ duration: ANIMATION_DURATION_300, curve: Curve.Linear }, () => {
                          this.isShowCellularData = false
                        })
                    })
                }
              }
            }
            //   .margin({ left: this.containerMargin.value })
            .GridColStyle()
            .height(this.isLandscapePhone ? '160vp' : this.HomeCardEditHeight.value)
            .transition(this.isAnimation ? TransitionEffect.scale({x: 0, y: 0}).animation({ duration: ANIMATION_DURATION_300 }):null)
            //æ¶ˆå¤±è§¦å‘å›è°ƒ
            .onDetach(() => {
              //ç»„ä»¶æˆªå›¾åˆ°åŠæ¨¡æ‹Ÿæ€çš„æ·»åŠ å°å¡ç‰‡é‡Œï¼Œæ–¹ä¾¿æ“ä½œ
              componentSnapshot.get('CellularDataId', (error: Error, pixmap: image.PixelMap) => {
                if (error) {
                  console.log("error: " + JSON.stringify(error))
                  return;
                }
                this.pixmapCellularData = pixmap //æˆªå›¾æ•ˆæœä¸ºåæ•ˆæœ
              })
            })
          }

          //å½“å‰èŠ‚ç‚¹å°å¡ç‰‡
          if (this.isShowCurrentNode) {
            GridCol({
              span: { xs: this.isLandscapePhone ? 3 : 6, md: this.isLandscapePhone ? 3 : this.isFoldStatus ? 4 : 6, lg: 3 },
              order: 4
            }) {
              Stack({ alignContent: Alignment.TopEnd }) {
                CurrentNode()
                if (this.isShowDeleteButton) {
                  DeleteButton2()
                    .position({ x: '90%', y: -4 })
                    .onClick(() => {
                        animateTo({ duration: ANIMATION_DURATION_300, curve: Curve.Linear }, () => {
                          this.isShowCurrentNode = false
                        })
                    })
                }
              }
            }
            .GridColStyle()
            .height(this.isLandscapePhone ? '160vp' : this.HomeCardEditHeight.value)
            .transition(this.isAnimation ? TransitionEffect.scale({x: 0, y: 0}).animation({ duration: ANIMATION_DURATION_300 }):null)
            //æ¶ˆå¤±è§¦å‘å›è°ƒ
            .onDetach(() => {
              //ç»„ä»¶æˆªå›¾åˆ°åŠæ¨¡æ‹Ÿæ€çš„æ·»åŠ å°å¡ç‰‡é‡Œï¼Œæ–¹ä¾¿æ“ä½œ
              componentSnapshot.get('CurrentNodeId', (error: Error, pixmap: image.PixelMap) => {
                if (error) {
                  console.log("error: " + JSON.stringify(error))
                  return;
                }
                this.pixmapCurrentNode = pixmap //æˆªå›¾æ•ˆæœä¸ºåæ•ˆæœ
              })
            })
          }

          //IPåœ°å€å°å¡ç‰‡
          if (this.isShowPublicNetwork) {
            GridCol({
              span: { xs: this.isLandscapePhone ? 3 : 6, md: this.isLandscapePhone ? 3 : this.isFoldStatus ? 4 : 6, lg: 3 },
              order: 5
            }) {
              Stack({ alignContent: Alignment.TopEnd }) {
                PublicNetwork()
                if (this.isShowDeleteButton) {
                  DeleteButton2()
                    .position({ x: '90%', y: -4 })
                    .onClick(() => {
                        animateTo({ duration: ANIMATION_DURATION_300, curve: Curve.Linear }, () => {
                          this.isShowPublicNetwork = false
                        })
                    })
                }
              }
            }
            .GridColStyle()
            .height(this.isLandscapePhone ? '160vp' : this.HomeCardEditHeight.value)
            .transition(this.isAnimation ? TransitionEffect.scale({x: 0, y: 0}).animation({ duration: ANIMATION_DURATION_300 }):null)
            //æ¶ˆå¤±è§¦å‘å›è°ƒ
            .onDetach(() => {
              //ç»„ä»¶æˆªå›¾åˆ°åŠæ¨¡æ‹Ÿæ€çš„æ·»åŠ å°å¡ç‰‡é‡Œï¼Œæ–¹ä¾¿æ“ä½œ
              componentSnapshot.get('PublicNetworkId', (error: Error, pixmap: image.PixelMap) => {
                if (error) {
                  console.log("error: " + JSON.stringify(error))
                  return;
                }
                this.pixmapPublicNetwork = pixmap //æˆªå›¾æ•ˆæœä¸ºåæ•ˆæœ
              })
            })
          }

          //æ”¶è—èŠ‚ç‚¹å°å¡ç‰‡
          if (this.isShowFavoriteProxy) {
            GridCol({
              span: { xs: this.isLandscapePhone ? 3 : 6, md: this.isLandscapePhone ? 3 : this.isFoldStatus ? 4 : 6, lg: 3 },
              order: 6
            }) {
              Stack({ alignContent: Alignment.TopEnd }) {
                FavoriteProxy()
                if (this.isShowDeleteButton) {
                  DeleteButton2()
                    .position({ x: '90%', y: -4 })
                    .onClick(() => {
                        animateTo({ duration: ANIMATION_DURATION_300, curve: Curve.Linear }, () => {
                          this.isShowFavoriteProxy = false
                        })
                    })
                }
              }
            }
            .GridColStyle()
            .height(this.isLandscapePhone ? '160vp' : this.HomeCardEditHeight.value)
            .transition(this.isAnimation ? TransitionEffect.scale({x: 0, y: 0}).animation({ duration: ANIMATION_DURATION_300 }):null)
            //æ¶ˆå¤±è§¦å‘å›è°ƒ
            .onDetach(() => {
              //ç»„ä»¶æˆªå›¾åˆ°åŠæ¨¡æ‹Ÿæ€çš„æ·»åŠ å°å¡ç‰‡é‡Œï¼Œæ–¹ä¾¿æ“ä½œ
              componentSnapshot.get('FavoriteProxyId', (error: Error, pixmap: image.PixelMap) => {
                if (error) {
                  console.log("error: " + JSON.stringify(error))
                  return;
                }
                this.pixmapFavoriteProxy = pixmap //æˆªå›¾æ•ˆæœä¸ºåæ•ˆæœ
              })
            })
          }

          //æ”¶è—é…ç½®å°å¡ç‰‡
          if (this.isShowFavoriteConfiguration) {
            GridCol({
              span: { xs: this.isLandscapePhone ? 3 : 6, md: this.isLandscapePhone ? 3 : this.isFoldStatus ? 4 : 6, lg: 3 },
              order: 7
            }) {
              Stack({ alignContent: Alignment.TopEnd }) {
                FavoriteConfiguration()
                if (this.isShowDeleteButton) {
                  DeleteButton2()
                    .position({ x: '90%', y: -4 })
                    .onClick(() => {
                        animateTo({ duration: ANIMATION_DURATION_300, curve: Curve.Linear }, () => {
                          this.isShowFavoriteConfiguration = false
                        })
                    })
                }
              }
            }
            .GridColStyle()
            .height(this.isLandscapePhone ? '160vp' : this.HomeCardEditHeight.value)
            .transition(this.isAnimation ? TransitionEffect.scale({x: 0, y: 0}).animation({ duration: ANIMATION_DURATION_300 }):null)
            //æ¶ˆå¤±è§¦å‘å›è°ƒ
            .onDetach(() => {
              //ç»„ä»¶æˆªå›¾åˆ°åŠæ¨¡æ‹Ÿæ€çš„æ·»åŠ å°å¡ç‰‡é‡Œï¼Œæ–¹ä¾¿æ“ä½œ
              componentSnapshot.get('FavoriteConfigurationId', (error: Error, pixmap: image.PixelMap) => {
                if (error) {
                  console.log("error: " + JSON.stringify(error))
                  return;
                }
                this.pixmapFavoriteConfiguration = pixmap //æˆªå›¾æ•ˆæœä¸ºåæ•ˆæœ
              })
            })
          }

          //èŠ‚ç‚¹ä¿¡æ¯å°å¡ç‰‡
          if (this.isShowProxyINFO) {
            GridCol({
              span: { xs: this.isLandscapePhone ? 6 : 12, md: this.isLandscapePhone ? 6 : this.isFoldStatus ? 8 :12, lg: 6 },
              order: 1
            }) {
              Stack({ alignContent: Alignment.TopEnd }) {
                ProxyINFO()
                if (this.isShowDeleteButton) {
                  DeleteButton1()
                    .position({ x: '95%', y: -4 })
                    .onClick(() => {
                        animateTo({ duration: ANIMATION_DURATION_300, curve: Curve.Linear }, () => {
                          this.isShowProxyINFO = false
                        })
                    })
                }
              }
            }
            .aspectRatio(2.07)
            .borderRadius(20)
            .backgroundColor($r('app.color.container_background'))
            .clickEffect({ level: ClickEffectLevel.MIDDLE })
            .transition(this.isAnimation ? TransitionEffect.scale({x: 0, y: 0}).animation({ duration: ANIMATION_DURATION_300 }):null)
            .height(this.isLandscapePhone ? '160vp' : this.HomeCardEditHeight.value)
            //æ¶ˆå¤±è§¦å‘å›è°ƒ
            .onDetach(() => {
              //ç»„ä»¶æˆªå›¾åˆ°åŠæ¨¡æ‹Ÿæ€çš„æ·»åŠ å°å¡ç‰‡é‡Œï¼Œæ–¹ä¾¿æ“ä½œ
              componentSnapshot.get('ProxyINFOId', (error: Error, pixmap: image.PixelMap) => {
                if (error) {
                  console.log("error: " + JSON.stringify(error))
                  return;
                }
                this.pixmapProxyINFO = pixmap //æˆªå›¾æ•ˆæœä¸ºåæ•ˆæœ
              })
            })
          }

          //å½“å‰é…ç½®å°å¡ç‰‡
          if (this.isShowCurrentConfiguration) {
            GridCol({
              span: { xs: this.isLandscapePhone ? 3 : 6, md: this.isLandscapePhone ? 3 : this.isFoldStatus ? 4 : 6, lg: 3 },
              order: 4
            }) {
              Stack({ alignContent: Alignment.TopEnd }) {
                CurrentConfiguration()
                if (this.isShowDeleteButton) {
                  DeleteButton2()
                    .position({ x: '90%', y: -4 })
                    .onClick(() => {
                        animateTo({ duration: ANIMATION_DURATION_300, curve: Curve.Linear}, () => {
                          this.isShowCurrentConfiguration = false
                        })
                    })
                }
              }
            }
            .GridColStyle()
            .height(this.isLandscapePhone ? '160vp' : this.HomeCardEditHeight.value)
            .transition(this.isAnimation ? TransitionEffect.scale({x: 0, y: 0}).animation({ duration: ANIMATION_DURATION_300 }):null)
            //æ¶ˆå¤±è§¦å‘å›è°ƒ
            .onDetach(() => {
              //ç»„ä»¶æˆªå›¾åˆ°åŠæ¨¡æ‹Ÿæ€çš„æ·»åŠ å°å¡ç‰‡é‡Œï¼Œæ–¹ä¾¿æ“ä½œ
              componentSnapshot.get('CurrentConfigurationId', (error: Error, pixmap: image.PixelMap) => {
                if (error) {
                  console.log("error: " + JSON.stringify(error))
                  return;
                }
                this.pixmapCurrentConfiguration = pixmap //æˆªå›¾æ•ˆæœä¸ºåæ•ˆæœ
              })
            })
          }

          //å¿«æ·æ–¹å¼å°å¡ç‰‡
          if (this.isFoldStatus? !this.isShowShortcuts:this.isShowShortcuts) {
            GridCol({
              span: { xs: this.isLandscapePhone ? 3 : 6, md: this.isLandscapePhone ? 3 : this.isFoldStatus ? 4 : 6, lg: 3 },
              order: 8
            }) {
              Stack({ alignContent: Alignment.TopEnd }) {
                Shortcuts()
                if (this.isShowDeleteButton) {
                  DeleteButton2()
                    .position({ x: '90%', y: -4 })
                    .onClick(() => {
                        animateTo({ duration: ANIMATION_DURATION_300, curve: Curve.Linear }, () => {
                          this.isShowShortcuts =this.isFoldStatus? true : false
                        })
                    })
                }
              }
            }
            .GridColStyle()
            .height(this.isLandscapePhone ? '160vp' : this.HomeCardEditHeight.value)
            .transition(this.isAnimation ? TransitionEffect.scale({x: 0, y: 0}).animation({ duration: ANIMATION_DURATION_300 }):null)
            //æ¶ˆå¤±è§¦å‘å›è°ƒ
            .onDetach(() => {
              //ç»„ä»¶æˆªå›¾åˆ°åŠæ¨¡æ‹Ÿæ€çš„æ·»åŠ å°å¡ç‰‡é‡Œï¼Œæ–¹ä¾¿æ“ä½œ
              componentSnapshot.get('ShortcutsId', (error: Error, pixmap: image.PixelMap) => {
                if (error) {
                  console.log("error: " + JSON.stringify(error))
                  return;
                }
                this.pixmapShortcuts = pixmap //æˆªå›¾æ•ˆæœä¸ºåæ•ˆæœ
              })
            })
          }
        } //GridRowçš„å°¾æ‹¬å·
        .width('100%')
        .padding(this.isLandscapePhone ? { top: 4, left: 25, right: 25 } :this.isFoldStatus ? { top: 4, left: 50, right: 50 } : this.HomeCardAreaPadding.value)
        .margin({ top: this.isLandscapePhone ? 7 : 0 })
      }
    }
    .width('100%')
    .height('100%')
    .scrollBar(BarState.Off)
    .contentEndOffset(70)
    .edgeEffect(EdgeEffect.Spring)
    .animation({ duration: ANIMATION_DURATION_300, curve: Curve.Ease })
    .bindSheet($$this.isShowCardEdit, this.CardEdit(), {
      detents: [BIND_SHEET_CONTAINER_HEIGHT, SheetSize.LARGE,],
      preferType: SheetType.CENTER,
      backgroundColor: $r('app.color.background'),
      showClose: true,
      dragBar: false,
      scrollSizeMode: ScrollSizeMode.CONTINUOUS,
      title: { title: $r('app.string.add_home_card') },
      onWillDismiss: () => {
        this.isShowCardEdit = false
        this.isEnableIndexForegroundBlur = false
      }
    })


        // ä»£ç†å¯åŠ¨æŒ‰é’®å±‚
        Column() {
          Row() {
            Stack({ alignContent: Alignment.Center }) {
              SymbolGlyph(this.proxyEnabled ? $r('sys.symbol.pause') : $r('sys.symbol.play_fill'))
                .fontSize(24)
                .fontColor([Color.White])
                .symbolEffect(this.ReplaceSymbolEffect)
                .align(Alignment.Center)
            }
            .width(this.proxyStartButtonHeight)
            .height(this.proxyStartButtonHeight)

            // .border({ width:2, radius: '50%', style: BorderStyle.Dashed, color: Color.White })
            // è®¡æ—¶å™¨æ–‡æœ¬
            Text(this.proxyStartingDuration)
              .fontSize(20)// ä½¿ç”¨é€æ˜åº¦æ§åˆ¶æ˜¯å¦æ˜¾ç¤ºè®¡æ—¶å™¨ï¼Œæ˜¯å› ä¸ºç”¨ `visibility` æ¥æ§åˆ¶çš„è¯ï¼Œä¸æ˜¾ç¤ºçš„æ—¶é—´é•¿äº†ä¹‹åï¼Œå†æ¬¡æ˜¾ç¤ºæ—¶å€™ä¼šå»¶è¿Ÿä¸€ç§’ï¼Œä½“éªŒä¸å¥½
              .fontColor(this.proxyEnabled ? Color.White : Color.Transparent)
              .fontWeight(FontWeight.Bold)
          }.width('100%')
        }
        .borderRadius(100)
        .backgroundColor(this.icon_emphasize)
        .shadow({
          radius: 10,
          color: this.icon_emphasize,
          offsetY: 4,
          type: ShadowType.BLUR
        })
        .margin($r('app.integer.vp_proxy_start_button_margin'))
        .width(this.proxyStartButtonWidth)
        .height(this.proxyStartButtonHeight)
        .clip(true)
        .onClick(async (event: ClickEvent) => {
          // TODO è°ƒç”¨å¯åŠ¨ä»£ç†æ–¹æ³• ç­‰å¾…ç»“æœå“åº”ä¹‹å å†åˆ‡æ¢æŒ‰é’®çŠ¶æ€å¼€å§‹è®¡æ—¶
          this.proxyEnabled = !this.proxyEnabled
          hilog.info(0xA002, this.componentName, `ä»£ç†å¯åŠ¨æŒ‰é’®çŠ¶æ€ï¼š${this.proxyEnabled}`)
          // å¼€å§‹è®¡æ—¶å™¨
          if (this.proxyEnabled) {
            this.proxyStartedTimer.start((formatTime) => {
              this.proxyStartingDuration = formatTime
            })
            await ClashViewModel.StartVpn()
          } else {
            this.proxyStartedTimer.reset()
            // å¦‚æœ`reset()`å°±å–æ¶ˆæ³¨é‡Šè¿™å¥ï¼Œå¦‚æœæ˜¯`pause()`å°±æ³¨é‡Šè¿™å¥
            this.proxyStartingDuration = PROXY_STARTED_DURATION_INIT_VALUE
            await ClashViewModel.StopVpn()
          }

          this.proxyStartButtonWidth = this.proxyEnabled ? $r('app.integer.vp_proxy_started_button_width') :
          $r('app.integer.vp_proxy_not_start_button_width')
        })
        .animation({ duration: ANIMATION_DURATION_300, curve: Curve.Ease })
        .clickEffect({ level: ClickEffectLevel.LIGHT })

      }
      .backgroundColor($r('app.color.background'))
  //    .padding(this.isLandscapePhone ? '0vp' : { bottom: '45vp' })
      .height(this.isLandscapePhone ? '100%' : `calc(100% - ${TAB_CONTENT_TITLE_HEIGHT}vp)`)
      .width("100%")
      .bindSheet($$this.isShowSettings, this.SettingsSheet(), {
        detents: [BIND_SHEET_CONTAINER_HEIGHT, SheetSize.LARGE],
        preferType: SheetType.CENTER,
        scrollSizeMode: ScrollSizeMode.CONTINUOUS,
        backgroundColor: $r('app.color.background'),
        dragBar: false,
        //keyboardAvoidMode: SheetKeyboardAvoidMode.RESIZE_ONLY,
        onWillDismiss: () => {
          this.isShowSettings = false
          this.isEnableIndexForegroundBlur = false
          this.SettingsPageInfos.clear()
        }
      })
    }.width('100%').height('100%')
  }
}


/**
 * ä¿å­˜æ ·å¼å’Œå†…å®¹å¼¹çª—æ§åˆ¶å™¨
 */
@CustomDialog
struct SaveCustomDialog {
  /* ä¸»é¢˜è‰² */
  @Consume('icon_emphasize')
  icon_emphasize: ResourceColor
  controller?: CustomDialogController
  /* æ˜¯å¦å¼€å¯ `Index` é¡µé¢çš„å‰æ™¯æ¨¡ç³Š */
  @Consume('isEnableIndexForegroundBlur')
  private isEnableIndexForegroundBlur: boolean

  cancel: () => void = () => {
  }
  confirm: () => void = () => {
  }

  build() {
    Column() {
      Text($r('app.string.Home_Save_Layout'))
        .fontSize(20)
        .fontColor($r('sys.color.font_primary'))

      Row() {
        Button($r('app.string.Give_Up'))
          .fontSize(16)
          .width(144)
          .fontColor(Color.Red)
          .backgroundColor('#00ffffff')
          .onClick(() => {
            if (this.controller != undefined) {
              this.controller.close()
            }
            this.cancel()
            this.isEnableIndexForegroundBlur = false
          })
        Blank(8)
        Button($r('app.string.Save'))
          .fontSize(16)
          .width(144)
          .backgroundColor(this.icon_emphasize)
          .onClick(() => {
            if (this.controller != undefined) {
              this.controller.close()
            }
            this.confirm()
            this.isEnableIndexForegroundBlur = false
          })
      }.padding({ top: 23 })
    }
    .width('100%')
    .height(undefined)
    .justifyContent(FlexAlign.Center)
    .backgroundColor($r('app.color.container_background'))
    .padding({ top: 16, bottom: 16 })
  }
}

export default Home

// å°å¡ç‰‡å…±æœ‰å±æ€§
@Extend(GridCol)
function GridColStyle() {
  .aspectRatio(1)
  .borderRadius(20)
  .backgroundColor($r('app.color.container_background'))
  .clickEffect({ level: ClickEffectLevel.MIDDLE })
}

//ç½‘ç»œæµ‹é€Ÿå¤§å¡ç‰‡é‡Œçš„åˆ é™¤æŒ‰é’®
@Component
struct DeleteButton1 {
  /*
ç¼–è¾‘æ¨¡å¼ä¸‹å³ä¸Šè§’åˆ é™¤æŒ‰é’®
 */
  @Consume deleteButtonSize: BreakpointState<number>
  /* å½“å‰è®¾å¤‡`height`æ˜¯å¦ç¬¦åˆ(320vp< height <= 500vp) */
  @StorageProp('isLandscapePhone') private isLandscapePhone: boolean = false
  /* æ˜¯å¦å¼€å¯å…¨å±€åŠ¨ç”»åˆ¤å®š */
  @Consume ('isAnimation') isAnimation: boolean

  build() {
    Button() {
      SymbolGlyph($r('sys.symbol.xmark'))
        .fontSize(16)
        .fontColor(['#fff'])
    }
    .borderRadius(20)
    .width(this.isLandscapePhone ? 24 : this.deleteButtonSize.value)
    .height(this.isLandscapePhone ? 24 : this.deleteButtonSize.value)
    .backgroundColor('#ffe84026')
    .transition(this.isAnimation ? TransitionEffect.scale({x: 0, y: 0}).animation({ duration: ANIMATION_DURATION_300 }):null)
  }
}

//æ™®é€šæ¨¡å¡ç‰‡é‡Œçš„åˆ é™¤æŒ‰é’®
@Component
struct DeleteButton2 {
  /*
ç¼–è¾‘æ¨¡å¼ä¸‹å³ä¸Šè§’åˆ é™¤æŒ‰é’®
 */
  @Consume deleteButtonSize: BreakpointState<number>
  /* å½“å‰è®¾å¤‡`height`æ˜¯å¦ç¬¦åˆ(320vp< height <= 500vp) */
  @StorageProp('isLandscapePhone') private isLandscapePhone: boolean = false
  /* æ˜¯å¦å¼€å¯å…¨å±€åŠ¨ç”»åˆ¤å®š */
  @Consume ('isAnimation') isAnimation: boolean

  build() {
    Button() {
      SymbolGlyph($r('sys.symbol.xmark'))
        .fontSize(16)
        .fontColor(['#fff'])
    }
    .borderRadius(20)
    .width(this.isLandscapePhone ? 24 : this.deleteButtonSize.value)
    .height(this.isLandscapePhone ? 24 : this.deleteButtonSize.value)
    .backgroundColor('#ffe84026')
    .transition(this.isAnimation ? TransitionEffect.scale({x: 0, y: 0}).animation({ duration: ANIMATION_DURATION_300 }):null)
  }
}

