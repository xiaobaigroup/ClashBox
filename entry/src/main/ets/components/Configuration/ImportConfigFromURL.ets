import {
  BIND_SHEET_MAIN_FONT_WEIGHT,
  BIND_SHEET_MAIN_FONTSIZE,
  BIND_SHEET_SUB_FONTSIZE,
  BIND_SHEET_DRAG_BAR_HEIGHT,
  BIND_SHEET_TITLE_LEFT_SYMBOL_WEIGHT,
  RouteName,
  ANIMATION_DURATION_300,
} from "../../common/Constants"
import { BindSheetTitleCustomBuilder, BindSheetTitleCustomBuilderMenu, CustomDownloadingDialog } from "../Common"
import { hilog } from "@kit.PerformanceAnalysisKit"
import { ConfigInfo } from "./ConfigInfo"
import { PromptAction, window } from "@kit.ArkUI"
import { ConfigData } from "../../common/PageArgumentEntity"
import { util } from "@kit.ArkTS"
import { CustomConfirmDialog } from '../Common'
import { BusinessError } from "@kit.BasicServicesKit"
import { common } from "@kit.AbilityKit"
import ClashViewModel from "../../entryability/ClashViewModel"
import { getResourceString } from "../../utils/ResourceStringUtil"


// å…³è”ï¼šroute_map.json
@Builder
export function ImportConfigFromURLBuilder(name: string, param: Object){
  ImportConfigFromURL()
}


@Component
export struct ImportConfigFromURL{

  private componentName: string = 'ImportConfigFromURL'
  private context = getContext() as common.UIAbilityContext
  private promptAction:PromptAction = this.getUIContext()?.getPromptAction()

  /* ä¸»é¢˜è‰² */
  @Consume('icon_emphasize')
  icon_emphasize: ResourceColor

  /* æ˜¯å¦å¼€å¯ é…ç½®é¡µ `bindSheet` ç»„ä»¶çš„å‰æ™¯æ¨¡ç³Š */
  @Consume('isEnableConfigPageBindSheetForegroundBlur')
  private isEnableConfigPageBindSheetForegroundBlur: boolean

  /* NV è·¯ç”±ç›¸å…³ */
  @Consume('configAddPageInfos')
  // é¡µé¢æ ˆ
  private configAddPageInfos: NavPathStack
  // é…ç½®è¯¦æƒ…ï¼ˆè¦æ·»åŠ åˆ°ç”¨æˆ·é¦–é€‰é¡¹é‡Œçš„æ•°æ®ï¼‰
  @State
  @Watch('configDataChanged')
  private configData: ConfigData = {
    configId: util.generateRandomUUID(),
    isNewConfig: true,
    configName: '',
    configUrl: '',
    isConfigAutoUpdate: false,
  }

  /* æ–­ç‚¹ç›¸å…³ */
  // NVå®¹å™¨çš„padding
  // @Consume('breakPointStateNavigationListPadding')
  // breakPointStateNavigationListPadding: BreakpointState<number>

  /* NV title Builder */
  @State
  private mainTitle: string = getResourceString($r('app.string.add_config'), this)
  @State
  private subTitle: string = getResourceString($r('app.string.Import_from_url'), this)
  // æ ‡é¢˜æ å·¥å…·èœå•
  // { symbol: $r('sys.symbol.star'), action: () => { this.menus.pop() } },
  // ä¿å­˜æŒ‰é’®
  private saveMenus: BindSheetTitleCustomBuilderMenu = {
    symbol: $r('sys.symbol.save'),
    symbolFontColor: ['#e6ffffff'],
    // è·Ÿéšä¸»é¢˜è‰²ï¼šç”±äºåœ¨è¿™é‡Œç›´æ¥èµ‹å€¼ this.icon_emphasize ç¼–è¯‘å™¨æç¤ºéœ€è¦åˆå§‹åŒ– this.icon_emphasize çš„å€¼ï¼Œæ”¾åˆ°äº† aboutToAppear å›è°ƒé‡Œé‡æ–°èµ‹å€¼
    symbolBackgroundColor: '#FF0A59F7',
    action: () => {
      this.saveConfig(this.configData.isNewConfig)
    }
  }
  // å½“å‰æ˜¾ç¤ºçš„å·¥å…·é›†åˆ é»˜è®¤ä¸ºç©º å¾…ä¸¤ä¸ªinputéƒ½æœ‰å€¼ä¹‹åæ‰åŠ å…¥ä¿å­˜æŒ‰é’®èœå•
  @State
  private menus: Array<BindSheetTitleCustomBuilderMenu> = []

  /* Inputäº‹ä»¶ç›¸å…³å˜é‡ */
  // [true: éƒ½æœ‰å€¼, false: ä¸æ˜¯æ‰€æœ‰çš„inputéƒ½æœ‰å€¼]
  @State
  private allInputHaveValue: boolean = false

  /* çˆ¶å­ä¼ å‚ */


  /* è‡ªå®šä¹‰å¼¹æ¡† */
  // é…ç½®æ˜¯å¦ä¿å­˜å¼¹æ¡† Controllerå®šä¹‰
  private configCustomConfirmDialogController: CustomDialogController | null= new CustomDialogController({
    builder: CustomConfirmDialog({
      title: $r('app.string.save_current_configuration'),
      cancelText: $r('app.string.Cancel'),
      confirmText: $r('app.string.Save'),
      cancelButtonBackgroundColor: Color.Transparent,
      // ä¸å¯ä»¥ä½¿ç”¨`@Consume`æ³¨è§£çš„å˜é‡
      // confirmButtonBackgroundColor: this.icon_emphasize,
      cancel: () => {
        this.isEnableConfigPageBindSheetForegroundBlur = false
        this.configAddPageInfos.pop(true)
      },
      confirm: ()=> {
        this.isEnableConfigPageBindSheetForegroundBlur = false
        this.saveConfig(this.configData.isNewConfig)
      }
    }),
    cancel: () => {
      this.isEnableConfigPageBindSheetForegroundBlur = false
    },
    autoCancel: true,
    alignment: DialogAlignment.Center,
    width: 328,
    backgroundColor: $r('app.color.list_item_background_color'),
  })
  // é…ç½®ä¸‹è½½å¼¹æ¡† titleåŠ¨æ€å€¼
  @State
  private customDownloadingDialogTitle: ResourceStr = $r('app.string.downloading_configuration_file')
  // é…ç½®ä¸‹è½½å¼¹æ¡† Controllerå®šä¹‰
  private configCustomDownloadingDialogController: CustomDialogController | null= new CustomDialogController({
    builder: CustomDownloadingDialog({
      title: this.customDownloadingDialogTitle,
      cancelText: $r('app.string.cancel_download'),
      cancel: () => {
        // TODO å–æ¶ˆä¸‹è½½æ–‡ä»¶ è‹¥å·²ä¸‹è½½éƒ¨åˆ†å°†æ­¤åˆ é™¤
        // ...
        this.promptAction.showToast({ message: `${getResourceString($r('app.string.configuration_download_canceled'), this)}ğŸ˜µ` })
      },
    }),
    // cancel: () => {},
    autoCancel: false,
    alignment: DialogAlignment.Center,
    width: 328,
    backgroundColor: $r('app.color.list_item_background_color'),
    onWillDismiss: () => {}
  })




  build() {
    NavDestination() {
      // æ›¿ä»£`NavDestination`çš„æ ‡é¢˜æ  START
      BindSheetTitleCustomBuilder({
        pageInfos: this.configAddPageInfos,
        // isSubPage: true,
        isSubPage: this.configData.isNewConfig,
        titlePaddingLeft: BIND_SHEET_DRAG_BAR_HEIGHT / 2,
        mainTitle: this.configData.isNewConfig ? this.mainTitle : 'ç¼–è¾‘é…ç½®',
        subTitle: this.configData.isNewConfig ? this.subTitle : '',
        mainTitleFontWeight: BIND_SHEET_MAIN_FONT_WEIGHT,
        mainTitleFontSize: BIND_SHEET_MAIN_FONTSIZE,
        subTitleFontSize: BIND_SHEET_SUB_FONTSIZE,
        titleBackgroundColor: $r('app.color.background'),
        padding: {
          // ä¸ºä»€ä¹ˆè®¾ç½®`15`ï¼Œçœ‹Builderçš„å‚æ•°ä¸­`padding`çš„ä»‹ç»ï¼šConfigAddBindSheetTitleBuilderParam
          left: 15,
          // left: this.breakPointStateNavigationListPadding.value,
          // é¿è®©`bindSheet`å³ä¸Šè§’çš„å‰å·æœ¬èº«`40vp`ã€å³`15vp`
          right: BIND_SHEET_TITLE_LEFT_SYMBOL_WEIGHT + 15
          // right: this.breakPointStateNavigationListPadding.value
        },
        menus: this.menus,
      })
      // æ›¿ä»£`NavDestination`çš„æ ‡é¢˜æ  END

      // é…ç½®ä¿¡æ¯ START
      ConfigInfo({configData: $configData})
      // é…ç½®ä¿¡æ¯ END
    }
    .height('100%')
    .hideTitleBar(true)
    // .title({builder: , height: BIND_SHEET_TITLE_CONTAINER_HEIGHT + BIND_SHEET_DRAG_BAR_HEIGHT})
    .backgroundColor($r('app.color.container_background'))
    .onBackPressed(() => {
      if (this.allInputHaveValue) {
        // å¼¹æ¡†æ˜¯å¦ä¿å­˜å·²ç»ç¼–è¾‘å¥½çš„é…ç½®
        this.configCustomConfirmDialogController?.open()
        // æ›´æ”¹bindSheetçš„å‰æ™¯æ¨¡ç³Š
        this.isEnableConfigPageBindSheetForegroundBlur = true
        return true
      } else {
        return false
      }
    })
    .onReady( () => {
      let paramJsonStr: string = JSON.stringify(this.configAddPageInfos.getParamByName(RouteName.IMPORT_CONFIG_FROM_URL))
      hilog.info(0xCA11, this.componentName, `#aboutToAppear#NavPathStack.getParamByName(${RouteName.IMPORT_CONFIG_FROM_URL}), result is: ${paramJsonStr}`)

      if( this.configAddPageInfos.getParamByName(RouteName.IMPORT_CONFIG_FROM_URL).length > 0 && this.configAddPageInfos.getParamByName(RouteName.IMPORT_CONFIG_FROM_URL)[0] !== null ) {
        try {
          this.configData = (JSON.parse(paramJsonStr) as Array<ConfigData>)[0]
        } catch (e) {
          let error = e as BusinessError;
          hilog.error(0xCA11, this.componentName, `#aboutToAppear#JSON.parse(paramJsonStr) as ConfigData#ERROR: code is [${error.code}],message is [${error.message}]`)
        }
      }
    })
    .animation({ duration: ANIMATION_DURATION_300, curve: Curve.Ease })

  }

  aboutToAppear(): void {
    hilog.info(0xCA10, this.componentName, `#aboutToAppear executed`)
    // XXX æ²¡æœ‰å†™`this.icon_emphasize`çš„`Watch`äº‹ä»¶ï¼Œæ˜¯å› ä¸ºå¦‚æœåœ¨è®¾ç½®é¡µé¢é‡Œè®¾ç½®äº†å…¶ä»–ä¸»é¢˜è‰²æ—¶ï¼Œè¿™ä¸ªé¡µé¢ä¸€å®šä¸æ˜¯æ‰“å¼€çš„çŠ¶æ€
    this.saveMenus.symbolBackgroundColor = this.icon_emphasize
  }

  aboutToDisappear(): void {
    hilog.info(0xCA10, this.componentName, `#aboutToDisappear executed`)
    // è‡ªå®šä¹‰å¼¹æ¡† æ¸…ç©º
    this.configCustomConfirmDialogController = null
    this.configCustomDownloadingDialogController = null
    this.isEnableConfigPageBindSheetForegroundBlur = false
    hilog.info(0xCA10, this.componentName, `#aboutToDisappear#ç½®ç©º[é…ç½®é¡µ\`bindSheet\`å†…æç¤ºæ˜¯å¦ä¿å­˜é…ç½®ä¿¡æ¯çš„è‡ªå®šä¹‰å¼¹æ¡†]`)
  }

  /**
   * TODO ä¿å­˜é…ç½®
   */
  async saveConfig(isNewConfig: boolean){
    if (isNewConfig) {
      this.customDownloadingDialogTitle = $r('app.string.downloading_configuration_file')
      this.configCustomDownloadingDialogController?.open()
      try {
        await ClashViewModel.addOrUpdateProfileByUrl(this.configData, null)
      } catch (e) {
        console.error("ClashNext", e.message, e.stack);
        this.promptAction.showToast({message: getResourceString($r('app.string.download_failed'), this) + e.message || e})
      }
      this.configCustomDownloadingDialogController?.close()
    } else {
      this.customDownloadingDialogTitle = $r('app.string.updating_configuration_file')
      this.configCustomDownloadingDialogController?.open()
      try {
        await ClashViewModel.addOrUpdateProfileByUrl(this.configData, this.configData.configId)
      } catch (e) {
        console.error("ClashNext", e.message, e.stack);
        this.promptAction.showToast({message: getResourceString($r('app.string.download_failed'), this) + e.message || e})
      }
      this.configCustomDownloadingDialogController?.close()
    }
  }

  /**
   * æ£€æŸ¥é…ç½®å Input && é…ç½® URL æ˜¯å¦éƒ½æœ‰å€¼
   *    true: æ˜¾ç¤ºä¿å­˜æŒ‰é’®ã€‚ falseåä¹‹
   */
  // checkInput() {
  //   if(this.configNameInputHaveText && this.configUrlInputHaveText) {
  //     this.menus.push(this.saveMenus)
  //   }
  // }

  /**
   * æ£€æŸ¥é…ç½®å Input && é…ç½® URL æ˜¯å¦éƒ½æœ‰å€¼
   *    true: æ˜¾ç¤ºä¿å­˜æŒ‰é’®ã€‚ falseåä¹‹
   */
  configDataChanged() {
    this.checkAllInputHaveValue()
    if (this.allInputHaveValue) {
      if (this.menus.filter(i => i === this.saveMenus).length <= 0) {
        // æ–°å¢`ä¿å­˜é…ç½®`èœå•æŒ‰é’®
        this.menus.push(this.saveMenus)
      }
    } else {
      // ç§»é™¤`ä¿å­˜é…ç½®`èœå•æŒ‰é’®
      for (let i = 0; i < this.menus.length; i++) {
        if (this.menus[i] === this.saveMenus) {
          this.menus.splice(i, 1)
          break
        }
      }
    }
  }

  /**
   * æ£€æŸ¥é…ç½®å Input && é…ç½® URL æ˜¯å¦éƒ½æœ‰å€¼
   */
  checkAllInputHaveValue() {
    this.allInputHaveValue = (this.configData.configUrl.length > 0)
    // hilog.info(0xCA12, this.componentName, `#checkAllInputHaveValue is [${this.allInputHaveValue}]}`)
  }
}